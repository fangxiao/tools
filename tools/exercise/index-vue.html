<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿åŠ¨ç›®æ ‡ç®¡ç† - Vueç‰ˆ</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/nav.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        .form-section {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }
        
        .section-title {
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            font-size: 1.4em;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .weight-inputs {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .weight-input {
            flex: 1;
            min-width: 140px;
        }
        
        .weight-input input {
            width: 100%;
        }
        
        .btn-add {
            background-color: #2ecc71;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .btn-add:hover {
            background-color: #27ae60;
        }
        
        .goals-section {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .goals-list {
            display: grid;
            gap: 20px;
        }
        
        .goal-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            background-color: #fafafa;
        }
        
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .goal-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .goal-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .goal-badge-completed {
            background-color: #2ecc71;
            color: white;
        }
        
        .goal-badge-failed {
            background-color: #e74c3c;
            color: white;
        }
        
        .goal-details {
            margin-bottom: 15px;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 8px;
        }
        
        .detail-label {
            font-weight: 600;
            width: 100px;
            color: #555;
        }
        
        .detail-value {
            flex: 1;
            color: #333;
        }
        
        .goal-progress {
            margin: 20px 0;
        }
        
        .goal-progress-section {
            margin-bottom: 15px;
        }
        
        .goal-progress-text {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #555;
        }
        
        .goal-progress-bar {
            height: 10px;
            background-color: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .goal-progress-fill {
            height: 100%;
            background-color: #2ecc71;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        
        .reminder-banner {
            background-color: #f39c12;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
        }
        
        .goal-status-text {
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .goal-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-use, .btn-details, .btn-summary, .btn-edit, .btn-delete {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .btn-use {
            background-color: #3498db;
            color: white;
        }
        
        .btn-use:hover {
            background-color: #2980b9;
        }
        
        .btn-details {
            background-color: #9b59b6;
            color: white;
        }
        
        .btn-details:hover {
            background-color: #8e44ad;
        }
        
        .btn-summary {
            background-color: #1abc9c;
            color: white;
        }
        
        .btn-summary:hover {
            background-color: #16a085;
        }
        
        .btn-edit {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-edit:hover {
            background-color: #d35400;
        }
        
        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-delete:hover {
            background-color: #c0392b;
        }
        
        .no-goals {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 20px;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #aaa;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        /* Alert Styles */
        .custom-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            border-radius: 4px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .custom-alert-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .custom-alert-error {
            background-color: #e74c3c;
            color: white;
        }
        
        .custom-alert-info {
            background-color: #3498db;
            color: white;
        }
        
        .custom-alert-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .custom-alert-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            margin-left: 15px;
        }
        
        /* Detail Records Styles */
        .detail-date-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .detail-date-header h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .detail-record {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .detail-record-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .detail-record-type {
            font-weight: bold;
            color: #3498db;
        }
        
        .detail-record-value {
            color: #2c3e50;
        }
        
        .detail-record-note {
            font-size: 0.9em;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .no-records {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 20px;
        }
        
        /* Record Actions */
        .detail-record-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }
        
        .btn-edit-small, .btn-delete-small {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-edit-small {
            background-color: #3498db;
            color: white;
        }
        
        .btn-delete-small {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-edit-small:hover {
            background-color: #2980b9;
        }
        
        .btn-delete-small:hover {
            background-color: #c0392b;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app">
        <nav-component></nav-component>
        
        <div class="container">
            <h1>è¿åŠ¨ç›®æ ‡ç®¡ç† - Vueç‰ˆ</h1>
            
            <!-- Add Goal Form -->
            <div class="form-section">
                <h2 class="section-title">æ·»åŠ è¿åŠ¨ç›®æ ‡</h2>
                <form @submit.prevent="addGoal">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="goal-period">ç›®æ ‡å‘¨æœŸï¼š</label>
                            <select id="goal-period" v-model="newGoal.period">
                                <option value="none">æ— å‘¨æœŸ</option>
                                <option value="daily">æ¯æ—¥</option>
                                <option value="weekly">æ¯å‘¨</option>
                                <option value="monthly">æ¯æœˆ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="goal-title">ç›®æ ‡æ ‡é¢˜ï¼š</label>
                            <input type="text" id="goal-title" v-model="newGoal.title" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="goal-target">ç›®æ ‡é‡ (km)ï¼š</label>
                            <input type="number" id="goal-target" v-model.number="newGoal.target" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="goal-start-date">å¼€å§‹æ—¥æœŸï¼š</label>
                            <input type="date" id="goal-start-date" v-model="newGoal.startDate" required>
                        </div>
                        <div class="form-group">
                            <label for="goal-end-date">ç»“æŸæ—¥æœŸï¼š</label>
                            <input type="date" id="goal-end-date" v-model="newGoal.endDate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ä½“é‡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                            <div class="weight-inputs">
                                <div class="weight-input">
                                    <input type="number" v-model.number="newGoal.initialWeight" step="0.1" min="0" placeholder="åˆå§‹ä½“é‡(kg)">
                                </div>
                                <div class="weight-input">
                                    <input type="number" v-model.number="newGoal.targetWeight" step="0.1" min="0" placeholder="ç›®æ ‡ä½“é‡(kg)">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <button type="submit" class="btn-add" :disabled="isAddingGoal">
                                <span v-if="!isAddingGoal">æ·»åŠ ç›®æ ‡</span>
                                <span v-else><span class="loading-spinner"></span> æ·»åŠ ä¸­...</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Goals List -->
            <div class="goals-section">
                <div class="section-title">
                    <h2>æˆ‘çš„è¿åŠ¨ç›®æ ‡</h2>
                    <button class="btn-summary" @click="showMonthlySummary" :disabled="isFetchingSummary">
                        <span v-if="!isFetchingSummary">æœˆåº¦æ±‡æ€»</span>
                        <span v-else><span class="loading-spinner"></span> åŠ è½½ä¸­...</span>
                    </button>
                </div>
                
                <div v-if="isLoadingGoals" class="no-goals">
                    åŠ è½½ä¸­...
                </div>
                
                <div v-else-if="goals.length === 0" class="no-goals">
                    æš‚æ— è¿åŠ¨ç›®æ ‡ï¼Œè¯·æ·»åŠ ä¸€ä¸ªç›®æ ‡ã€‚
                </div>
                
                <div v-else class="goals-list">
                    <div class="goal-card" v-for="goal in goals" :key="goal.id">
                        <div class="goal-header">
                            <div class="goal-title">{{ goal.title }}</div>
                            <div v-if="getGoalStatus(goal) === 'completed'" class="goal-badge goal-badge-completed">å·²å®Œæˆ</div>
                            <div v-else-if="getGoalStatus(goal) === 'failed'" class="goal-badge goal-badge-failed">æœªå®Œæˆ</div>
                        </div>
                        <div class="goal-details">
                            <div class="detail-row">
                                <div class="detail-label">ç›®æ ‡é‡:</div>
                                <div class="detail-value">{{ goal.target }} km</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">æ—¶é—´èŒƒå›´:</div>
                                <div class="detail-value">{{ goal.start_date }} è‡³ {{ goal.end_date }}</div>
                            </div>
                            <div v-if="goal.initial_weight || goal.current_weight || goal.target_weight" class="detail-row">
                                <div class="detail-label">ä½“é‡ä¿¡æ¯:</div>
                                <div class="detail-value">
                                    <span v-if="goal.initial_weight">åˆå§‹: {{ goal.initial_weight }}kg</span>
                                    <span v-if="goal.current_weight"> å½“å‰: {{ goal.current_weight }}kg</span>
                                    <span v-if="goal.target_weight"> ç›®æ ‡: {{ goal.target_weight }}kg</span>
                                </div>
                            </div>
                        </div>
                        <div class="goal-progress">
                            <div class="goal-progress-section">
                                <div class="goal-progress-text">è¿åŠ¨è¿›åº¦: {{ calculateGoalProgress(goal).current.toFixed(1) }} / {{ calculateGoalProgress(goal).target }} km ({{ calculateGoalProgress(goal).percentage.toFixed(1) }}%)</div>
                                <div class="goal-progress-bar">
                                    <div class="goal-progress-fill" :style="{ width: Math.min(calculateGoalProgress(goal).percentage, 100) + '%' }"></div>
                                </div>
                            </div>
                            
                            <div class="goal-progress-section">
                                <div class="goal-progress-text">æ—¶é—´è¿›åº¦: {{ calculateTimeProgress(goal).percentage.toFixed(1) }}%</div>
                                <div class="goal-progress-bar">
                                    <div class="goal-progress-fill" :style="{ width: Math.min(calculateTimeProgress(goal).percentage, 100) + '%', backgroundColor: '#3498db' }"></div>
                                </div>
                            </div>
                            
                            <div v-if="goal.initial_weight && goal.current_weight && goal.target_weight" class="goal-progress-section">
                                <div class="goal-progress-text">ä½“é‡è¿›åº¦: {{ ((Math.abs(goal.initial_weight - goal.current_weight) / Math.abs(goal.initial_weight - goal.target_weight)) * 100).toFixed(1) }}%</div>
                                <div class="goal-progress-bar">
                                    <div class="goal-progress-fill" 
                                         :style="{ 
                                             width: Math.min(100, (Math.abs(goal.initial_weight - goal.current_weight) / Math.abs(goal.initial_weight - goal.target_weight)) * 100) + '%', 
                                             backgroundColor: goal.initial_weight > goal.target_weight ? (goal.current_weight <= goal.target_weight ? '#2ecc71' : '#e74c3c') : (goal.current_weight >= goal.target_weight ? '#2ecc71' : '#e74c3c')
                                         }">
                                    </div>
                                </div>
                            </div>
                            
                            <div v-if="calculateGoalProgress(goal).percentage < calculateTimeProgress(goal).percentage" class="reminder-banner">
                                ğŸ’¡ è¿åŠ¨è¿›åº¦è½åäºæ—¶é—´è¿›åº¦ï¼ŒåŠ æ²¹è¿åŠ¨å§ï¼
                            </div>
                            
                            <div class="goal-status-text">
                                <span v-if="calculateGoalProgress(goal).percentage >= 100">ğŸ‰ ç›®æ ‡å·²å®Œæˆ!</span>
                                <span v-else-if="calculateGoalProgress(goal).percentage >= 80">ğŸ’ª å¿«å®Œæˆç›®æ ‡äº†!</span>
                                <span v-else-if="calculateGoalProgress(goal).percentage >= 50">ğŸ‘ å·²å®Œæˆä¸€åŠä»¥ä¸Š!</span>
                                <span v-else-if="calculateGoalProgress(goal).percentage >= 30">ğŸƒâ€â™‚ï¸ åŠ æ²¹ï¼Œç»§ç»­åŠªåŠ›!</span>
                                <span v-else>ğŸš€ ä»éœ€åŠªåŠ›ï¼Œç»§ç»­åŠ æ²¹!</span>
                            </div>
                        </div>
                        <div class="goal-actions">
                            <button class="btn-use" @click="showCheckInModal(goal)">æ‰“å¡</button>
                            <button class="btn-details" @click="showDetailsModal(goal)">æ‰“å¡æ˜ç»†</button>
                            <button class="btn-summary" @click="showGoalSummary(goal)">æ±‡æ€»</button>
                            <button class="btn-edit" @click="showEditGoalModal(goal)">ç¼–è¾‘</button>
                            <button class="btn-delete" @click="deleteGoal(goal)">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Check-in Modal -->
        <div class="modal-overlay" v-if="showCheckInModalFlag">
            <div class="modal">
                <div class="modal-header">
                    <h3>è¿åŠ¨æ‰“å¡ - {{ selectedGoal.title }}</h3>
                    <button class="modal-close" @click="closeModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveCheckIn">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="checkin-exercise-type">è¿åŠ¨ç±»åˆ«ï¼š</label>
                                <select id="checkin-exercise-type" v-model="checkInData.exerciseType" required>
                                    <option value="">é€‰æ‹©è¿åŠ¨ç±»åˆ«</option>
                                    <option v-for="type in exerciseTypes" :key="type.id" :value="type.id">{{ type.name }}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="checkin-value">è¿åŠ¨é‡ï¼š</label>
                                <input type="number" id="checkin-value" v-model.number="checkInData.value" step="0.1" min="0" required>
                                <span>{{ getUnitForExerciseType(checkInData.exerciseType) }}</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="checkin-weight">å½“å‰ä½“é‡ (kg)ï¼š</label>
                                <input type="number" id="checkin-weight" v-model.number="checkInData.weight" step="0.1" min="0" :value="selectedGoal.current_weight">
                            </div>
                            <div class="form-group">
                                <label for="checkin-date">æ—¥æœŸï¼š</label>
                                <input type="date" id="checkin-date" v-model="checkInData.date" :value="new Date().toISOString().split('T')[0]" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="checkin-note">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                                <input type="text" id="checkin-note" v-model="checkInData.note">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <button type="submit" class="btn-add" :disabled="isSavingCheckIn">
                                    <span v-if="!isSavingCheckIn">å®Œæˆæ‰“å¡</span>
                                    <span v-else><span class="loading-spinner"></span> æ‰“å¡ä¸­...</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Details Modal -->
        <div class="modal-overlay" v-if="showDetailsModalFlag">
            <div class="modal">
                <div class="modal-header">
                    <h3>æ‰“å¡æ˜ç»† - {{ selectedGoal.title }}</h3>
                    <button class="modal-close" @click="closeModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div v-if="isLoadingRecords" class="no-records">
                        åŠ è½½ä¸­...
                    </div>
                    <div v-else-if="selectedGoalRecords.length === 0" class="no-records">
                        æš‚æ— æ‰“å¡è®°å½•
                    </div>
                    <div v-else>
                        <div class="detail-date-section" v-for="(records, date) in groupRecordsByDate(selectedGoalRecords)" :key="date">
                            <div class="detail-date-header">
                                <h4>{{ date }} (æ€»è®¡: {{ calculateDailyTotal(records).toFixed(1) }} km)</h4>
                            </div>
                            <div class="detail-date-records">
                                <div class="detail-record" v-for="record in records" :key="record.id">
                                    <div class="detail-record-info">
                                        <div class="detail-record-type">{{ getExerciseTypeName(record.exercise_type) }}</div>
                                        <div class="detail-record-value">{{ record.value }} {{ getUnitForExerciseType(record.exercise_type) }}</div>
                                    </div>
                                    <div v-if="record.note" class="detail-record-note">{{ record.note }}</div>
                                    <div class="detail-record-actions">
                                        <button class="btn-edit-small" @click="editRecord(record)">ç¼–è¾‘</button>
                                        <button class="btn-delete-small" @click="deleteRecord(record)">åˆ é™¤</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Edit Record Modal -->
        <div class="modal-overlay" v-if="showEditRecordModal">
            <div class="modal">
                <div class="modal-header">
                    <h3>ç¼–è¾‘æ‰“å¡è®°å½•</h3>
                    <button class="modal-close" @click="closeModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveEditedRecord">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-exercise-type">è¿åŠ¨ç±»åˆ«ï¼š</label>
                                <select id="edit-exercise-type" v-model="editingRecord.exerciseType" required>
                                    <option value="">é€‰æ‹©è¿åŠ¨ç±»åˆ«</option>
                                    <option v-for="type in exerciseTypes" :key="type.id" :value="type.id" :selected="type.id === editingRecord.exerciseType">{{ type.name }}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="edit-value">è¿åŠ¨é‡ï¼š</label>
                                <input type="number" id="edit-value" v-model.number="editingRecord.value" step="0.1" min="0" required>
                                <span>{{ getUnitForExerciseType(editingRecord.exerciseType) }}</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-date">æ—¥æœŸï¼š</label>
                                <input type="date" id="edit-date" v-model="editingRecord.recordDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-note">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                                <input type="text" id="edit-note" v-model="editingRecord.note">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <button type="submit" class="btn-add" :disabled="isUpdatingRecord">
                                    <span v-if="!isUpdatingRecord">ä¿å­˜ä¿®æ”¹</span>
                                    <span v-else><span class="loading-spinner"></span> ä¿å­˜ä¸­...</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="/nav.js"></script>
    <script type="module">
        const { createApp, ref, reactive, onMounted } = Vue;
        
        createApp({
            setup() {
                // State
                const currentUser = ref(JSON.parse(localStorage.getItem('currentUser')) || null);
                const goals = ref([]);
                const records = ref([]);
                const isLoadingGoals = ref(false);
                const isAddingGoal = ref(false);
                const isSavingCheckIn = ref(false);
                const isUpdatingRecord = ref(false);
                const isFetchingSummary = ref(false);
                const isLoadingRecords = ref(false);
                
                // Modals
                const showCheckInModalFlag = ref(false);
                const showDetailsModalFlag = ref(false);
                const showEditRecordModal = ref(false);
                
                // Selected items
                const selectedGoal = ref(null);
                const selectedGoalRecords = ref([]);
                
                // Forms data
                const newGoal = reactive({
                    period: 'monthly',
                    title: '',
                    target: 50,
                    startDate: '',
                    endDate: '',
                    initialWeight: null,
                    targetWeight: null
                });
                
                const checkInData = reactive({
                    exerciseType: '',
                    value: 0,
                    weight: null,
                    date: new Date().toISOString().split('T')[0],
                    note: ''
                });
                
                const editingRecord = reactive({
                    id: null,
                    exerciseType: '',
                    value: 0,
                    recordDate: new Date().toISOString().split('T')[0],
                    note: ''
                });
                
                // Exercise types
                const exerciseTypes = [
                    { id: 'running', name: 'è·‘æ­¥', unit: 'km' },
                    { id: 'walking', name: 'èµ°è·¯', unit: 'km' },
                    { id: 'cycling', name: 'éª‘è½¦', unit: 'km' },
                    { id: 'swimming', name: 'æ¸¸æ³³', unit: 'å°æ—¶' },
                    { id: 'boxing', name: 'æ‹³å‡»', unit: 'å°æ—¶' },
                    { id: 'rowing', name: 'åˆ’èˆ¹', unit: 'km' },
                    { id: 'climbing_stairs', name: 'çˆ¬æ¥¼æ¢¯', unit: 'å°æ—¶' },
                    { id: 'basketball', name: 'ç¯®çƒ', unit: 'å°æ—¶' },
                    { id: 'football', name: 'è¶³çƒ', unit: 'å°æ—¶' },
                    { id: 'badminton', name: 'ç¾½æ¯›çƒ', unit: 'å°æ—¶' },
                    { id: 'table_tennis', name: 'ä¹’ä¹“çƒ', unit: 'å°æ—¶' },
                    { id: 'tennis', name: 'ç½‘çƒ', unit: 'å°æ—¶' },
                    { id: 'golf', name: 'é«˜å°”å¤«', unit: 'å°æ—¶' },
                    { id: 'billiards', name: 'å°çƒ', unit: 'å°æ—¶' },
                    { id: 'weight_lifting', name: 'æ’¸é“', unit: 'å°æ—¶' },
                    { id: 'mountain_climbing', name: 'ç™»å±±', unit: 'km' }
                ];
                
                // Initialize date fields
                const initDateFields = () => {
                    const today = new Date();
                    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    
                    newGoal.startDate = firstDayOfMonth.toISOString().split('T')[0];
                    newGoal.endDate = lastDayOfMonth.toISOString().split('T')[0];
                    updateGoalTitle();
                };
                
                // Update goal title based on period
                const updateGoalTitle = () => {
                    const today = new Date();
                    switch (newGoal.period) {
                        case 'none':
                            newGoal.title = 'è‡ªå®šä¹‰è¿åŠ¨ç›®æ ‡';
                            break;
                        case 'monthly':
                            newGoal.title = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆè¿åŠ¨ç›®æ ‡`;
                            break;
                        case 'weekly':
                            const weekNumber = getWeekNumber(today);
                            newGoal.title = `${today.getFullYear()}å¹´ç¬¬${weekNumber}å‘¨è¿åŠ¨ç›®æ ‡`;
                            break;
                        case 'daily':
                            newGoal.title = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥è¿åŠ¨ç›®æ ‡`;
                            break;
                    }
                };
                
                // Get week number
                const getWeekNumber = (date) => {
                    const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
                    const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
                    return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
                };
                
                // Auth check
                const checkAuth = () => {
                    if (!currentUser.value) {
                        window.location.href = '/login.html';
                        return false;
                    }
                    return true;
                };
                
                // Fetch goals
                const fetchGoals = async () => {
                    if (!checkAuth()) return;
                    
                    isLoadingGoals.value = true;
                    try {
                        const response = await fetch(`/api/exercise-goals?userId=${currentUser.value.id}`);
                        if (!response.ok) throw new Error('è·å–è¿åŠ¨ç›®æ ‡å¤±è´¥');
                        goals.value = await response.json();
                    } catch (error) {
                        showAlert('åŠ è½½è¿åŠ¨ç›®æ ‡å¤±è´¥: ' + error.message, 'error');
                    } finally {
                        isLoadingGoals.value = false;
                    }
                };
                
                // Fetch records
                const fetchRecords = async () => {
                    if (!checkAuth()) return;
                    
                    try {
                        const response = await fetch(`/api/exercise-records?userId=${currentUser.value.id}`);
                        if (!response.ok) throw new Error('è·å–è¿åŠ¨è®°å½•å¤±è´¥');
                        records.value = await response.json();
                    } catch (error) {
                        showAlert('åŠ è½½è¿åŠ¨è®°å½•å¤±è´¥: ' + error.message, 'error');
                    }
                };
                
                // Add goal
                const addGoal = async () => {
                    if (!checkAuth()) return;
                    
                    isAddingGoal.value = true;
                    try {
                        const goalData = {
                            title: newGoal.title,
                            target: newGoal.target,
                            period: newGoal.period,
                            startDate: newGoal.startDate,
                            endDate: newGoal.endDate,
                            initialWeight: newGoal.initialWeight || null,
                            targetWeight: newGoal.targetWeight || null
                        };
                        
                        const response = await fetch(`/api/exercise-goals?userId=${currentUser.value.id}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(goalData)
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'åˆ›å»ºç›®æ ‡å¤±è´¥');
                        }
                        
                        await response.json();
                        await fetchGoals();
                        
                        // Reset form
                        newGoal.target = 50;
                        initDateFields();
                        
                        showAlert('ç›®æ ‡åˆ›å»ºæˆåŠŸï¼', 'success');
                    } catch (error) {
                        showAlert(error.message || 'åˆ›å»ºç›®æ ‡å¤±è´¥', 'error');
                    } finally {
                        isAddingGoal.value = false;
                    }
                };
                
                // Delete goal
                const deleteGoal = async (goal) => {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¿åŠ¨ç›®æ ‡å—ï¼Ÿ\n\næ³¨æ„ï¼šåˆ é™¤ç›®æ ‡ä¼šåŒæ—¶åˆ é™¤æ‰€æœ‰ç›¸å…³çš„æ‰“å¡è®°å½•ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/api/exercise-goals/${goal.id}?userId=${currentUser.value.id}`, {
                            method: 'DELETE'
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'åˆ é™¤å¤±è´¥');
                        }
                        
                        await fetchGoals();
                        showAlert('ç›®æ ‡åˆ é™¤æˆåŠŸï¼', 'success');
                    } catch (error) {
                        showAlert('åˆ é™¤ç›®æ ‡å¤±è´¥: ' + error.message, 'error');
                    }
                };
                
                // Show check-in modal
                const showCheckInModal = (goal) => {
                    selectedGoal.value = goal;
                    checkInData.exerciseType = '';
                    checkInData.value = 0;
                    checkInData.weight = goal.current_weight || null;
                    checkInData.date = new Date().toISOString().split('T')[0];
                    checkInData.note = '';
                    showCheckInModalFlag.value = true;
                };
                
                // Save check-in
                const saveCheckIn = async () => {
                    if (!checkAuth()) return;
                    
                    isSavingCheckIn.value = true;
                    try {
                        const recordData = {
                            goalId: selectedGoal.value.id,
                            exerciseType: checkInData.exerciseType,
                            value: checkInData.value,
                            recordDate: checkInData.date,
                            note: checkInData.note
                        };
                        
                        const response = await fetch(`/api/exercise-records?userId=${currentUser.value.id}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(recordData)
                        });
                        
                        if (!response.ok) {
                            throw new Error('æ‰“å¡å¤±è´¥');
                        }
                        
                        // If weight is provided, update the goal's current weight
                        if (checkInData.weight) {
                            const weightResponse = await fetch(`/api/exercise-goals/${selectedGoal.value.id}/weight?userId=${currentUser.value.id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ currentWeight: checkInData.weight })
                            });
                            
                            if (!weightResponse.ok) {
                                throw new Error('æ›´æ–°ä½“é‡å¤±è´¥');
                            }
                        }
                        
                        closeModal();
                        await fetchGoals();
                        showAlert('æ‰“å¡æˆåŠŸï¼', 'success');
                    } catch (error) {
                        showAlert('æ‰“å¡å¤±è´¥: ' + error.message, 'error');
                    } finally {
                        isSavingCheckIn.value = false;
                    }
                };
                
                // Show details modal
                const showDetailsModal = async (goal) => {
                    selectedGoal.value = goal;
                    showDetailsModalFlag.value = true;
                    isLoadingRecords.value = true;
                    
                    try {
                        const response = await fetch(`/api/exercise-records/goal/${goal.id}?userId=${currentUser.value.id}`);
                        if (!response.ok) throw new Error('è·å–è¿åŠ¨è®°å½•å¤±è´¥');
                        selectedGoalRecords.value = await response.json();
                    } catch (error) {
                        showAlert('åŠ è½½è¿åŠ¨è®°å½•å¤±è´¥: ' + error.message, 'error');
                    } finally {
                        isLoadingRecords.value = false;
                    }
                };
                
                // Edit record
                const editRecord = async (record) => {
                    try {
                        const response = await fetch(`/api/exercise-records/single/${record.id}?userId=${currentUser.value.id}`);
                        if (!response.ok) throw new Error('è·å–è¿åŠ¨è®°å½•å¤±è´¥');
                        const recordData = await response.json();
                        
                        editingRecord.id = recordData.id;
                        editingRecord.exerciseType = recordData.exercise_type;
                        editingRecord.value = recordData.value;
                        editingRecord.recordDate = recordData.record_date;
                        editingRecord.note = recordData.note || '';
                        
                        showEditRecordModal.value = true;
                    } catch (error) {
                        showAlert('åŠ è½½æ‰“å¡è®°å½•å¤±è´¥: ' + error.message, 'error');
                    }
                };
                
                // Save edited record
                const saveEditedRecord = async () => {
                    isUpdatingRecord.value = true;
                    try {
                        const recordData = {
                            exerciseType: editingRecord.exerciseType,
                            value: editingRecord.value,
                            recordDate: editingRecord.recordDate,
                            note: editingRecord.note
                        };
                        
                        const response = await fetch(`/api/exercise-records/${editingRecord.id}?userId=${currentUser.value.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(recordData)
                        });
                        
                        if (!response.ok) {
                            throw new Error('æ›´æ–°æ‰“å¡è®°å½•å¤±è´¥');
                        }
                        
                        closeModal();
                        await showDetailsModal(selectedGoal.value);
                        showAlert('æ‰“å¡è®°å½•æ›´æ–°æˆåŠŸï¼', 'success');
                    } catch (error) {
                        showAlert('æ›´æ–°æ‰“å¡è®°å½•å¤±è´¥: ' + error.message, 'error');
                    } finally {
                        isUpdatingRecord.value = false;
                    }
                };
                
                // Delete record
                const deleteRecord = async (record) => {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/api/exercise-records/${record.id}?userId=${currentUser.value.id}`, {
                            method: 'DELETE'
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'åˆ é™¤å¤±è´¥');
                        }
                        
                        await showDetailsModal(selectedGoal.value);
                        showAlert('æ‰“å¡è®°å½•åˆ é™¤æˆåŠŸï¼', 'success');
                    } catch (error) {
                        showAlert('åˆ é™¤æ‰“å¡è®°å½•å¤±è´¥: ' + error.message, 'error');
                    }
                };
                
                // Show edit goal modal
                const showEditGoalModal = (goal) => {
                    // Implementation would go here
                    showAlert('ç¼–è¾‘åŠŸèƒ½å°šæœªå®Œå…¨å®ç°', 'info');
                };
                
                // Show goal summary
                const showGoalSummary = (goal) => {
                    // Implementation would go here
                    showAlert('ç›®æ ‡æ±‡æ€»åŠŸèƒ½å°šæœªå®Œå…¨å®ç°', 'info');
                };
                
                // Show monthly summary
                const showMonthlySummary = async () => {
                    isFetchingSummary.value = true;
                    try {
                        // Implementation would go here
                        showAlert('æœˆåº¦æ±‡æ€»åŠŸèƒ½å°šæœªå®Œå…¨å®ç°', 'info');
                    } catch (error) {
                        showAlert('åŠ è½½æœˆåº¦æ€»ç»“å¤±è´¥: ' + error.message, 'error');
                    } finally {
                        isFetchingSummary.value = false;
                    }
                };
                
                // Calculate goal progress
                const calculateGoalProgress = (goal) => {
                    const recordsForGoal = records.value.filter(record => record.goal_id == goal.id);
                    let current = 0;
                    
                    recordsForGoal.forEach(record => {
                        const exerciseType = exerciseTypes.find(type => type.id === record.exercise_type);
                        if (exerciseType) {
                            if (exerciseType.unit === 'å°æ—¶') {
                                if (exerciseType.id === 'swimming') {
                                    current += record.value * 10;
                                } else {
                                    current += record.value * 5;
                                }
                            } else if (exerciseType.id === 'cycling') {
                                current += record.value * 0.5;
                            } else {
                                current += record.value;
                            }
                        }
                    });
                    
                    return {
                        current: current,
                        target: goal.target,
                        percentage: goal.target > 0 ? (current / goal.target) * 100 : 0
                    };
                };
                
                // Calculate time progress
                const calculateTimeProgress = (goal) => {
                    const startDate = new Date(goal.start_date);
                    const endDate = new Date(goal.end_date);
                    const currentDate = new Date();
                    
                    const actualCurrentDate = currentDate < startDate ? startDate : 
                                            currentDate > endDate ? endDate : currentDate;
                    
                    const totalDuration = endDate - startDate;
                    const elapsedDuration = actualCurrentDate - startDate;
                    
                    const percentage = totalDuration > 0 ? (elapsedDuration / totalDuration) * 100 : 0;
                    
                    return {
                        percentage: percentage
                    };
                };
                
                // Get goal status
                const getGoalStatus = (goal) => {
                    const progress = calculateGoalProgress(goal);
                    const timeProgress = calculateTimeProgress(goal);
                    const currentDate = new Date();
                    const endDate = new Date(goal.end_date);
                    
                    if (progress.current >= goal.target) {
                        return 'completed';
                    }
                    
                    if (currentDate > endDate && progress.current < goal.target) {
                        return 'failed';
                    }
                    
                    return 'in-progress';
                };
                
                // Get unit for exercise type
                const getUnitForExerciseType = (typeId) => {
                    const type = exerciseTypes.find(t => t.id === typeId);
                    return type ? type.unit : 'km';
                };
                
                // Get exercise type name
                const getExerciseTypeName = (typeId) => {
                    const type = exerciseTypes.find(t => t.id === typeId);
                    return type ? type.name : 'æœªçŸ¥ç±»å‹';
                };
                
                // Group records by date
                const groupRecordsByDate = (records) => {
                    const grouped = {};
                    records.forEach(record => {
                        if (!grouped[record.record_date]) {
                            grouped[record.record_date] = [];
                        }
                        grouped[record.record_date].push(record);
                    });
                    return grouped;
                };
                
                // Calculate daily total
                const calculateDailyTotal = (dailyRecords) => {
                    let total = 0;
                    dailyRecords.forEach(record => {
                        const exerciseType = exerciseTypes.find(type => type.id === record.exercise_type);
                        if (exerciseType) {
                            if (exerciseType.unit === 'å°æ—¶') {
                                if (exerciseType.id === 'swimming') {
                                    total += record.value * 10;
                                } else {
                                    total += record.value * 5;
                                }
                            } else if (exerciseType.id === 'cycling') {
                                total += record.value * 0.5;
                            } else {
                                total += record.value;
                            }
                        }
                    });
                    return total;
                };
                
                // Close modal
                const closeModal = () => {
                    showCheckInModalFlag.value = false;
                    showDetailsModalFlag.value = false;
                    showEditRecordModal.value = false;
                };
                
                // Show alert
                const showAlert = (message, type = 'info') => {
                    // Remove any existing alerts
                    const existingAlert = document.querySelector('.custom-alert');
                    if (existingAlert) {
                        document.body.removeChild(existingAlert);
                    }
                    
                    // Create alert element
                    const alertElement = document.createElement('div');
                    alertElement.className = `custom-alert custom-alert-${type}`;
                    alertElement.innerHTML = `
                        <div class="custom-alert-content">
                            <span class="custom-alert-message">${message}</span>
                            <button class="custom-alert-close">&times;</button>
                        </div>
                    `;
                    
                    document.body.appendChild(alertElement);
                    
                    // Add close event
                    alertElement.querySelector('.custom-alert-close').addEventListener('click', function() {
                        document.body.removeChild(alertElement);
                    });
                    
                    // Auto close after 3 seconds
                    setTimeout(() => {
                        if (document.body.contains(alertElement)) {
                            document.body.removeChild(alertElement);
                        }
                    }, 3000);
                };
                
                // Lifecycle hooks
                onMounted(() => {
                    if (checkAuth()) {
                        initDateFields();
                        fetchGoals();
                        fetchRecords();
                    }
                });
                
                // Watchers
                const watchPeriod = () => {
                    updateGoalTitle();
                };
                
                // Return exposed state and methods
                return {
                    // State
                    currentUser,
                    goals,
                    records,
                    isLoadingGoals,
                    isAddingGoal,
                    isSavingCheckIn,
                    isUpdatingRecord,
                    isFetchingSummary,
                    isLoadingRecords,
                    
                    // Modals
                    showCheckInModalFlag,
                    showDetailsModalFlag,
                    showEditRecordModal,
                    
                    // Selected items
                    selectedGoal,
                    selectedGoalRecords,
                    
                    // Forms data
                    newGoal,
                    checkInData,
                    editingRecord,
                    
                    // Constants
                    exerciseTypes,
                    
                    // Methods
                    updateGoalTitle,
                    addGoal,
                    deleteGoal,
                    showCheckInModal,
                    saveCheckIn,
                    showDetailsModal,
                    editRecord,
                    saveEditedRecord,
                    deleteRecord,
                    showEditGoalModal,
                    showGoalSummary,
                    showMonthlySummary,
                    calculateGoalProgress,
                    calculateTimeProgress,
                    getGoalStatus,
                    getUnitForExerciseType,
                    getExerciseTypeName,
                    groupRecordsByDate,
                    calculateDailyTotal,
                    closeModal
                };
            }
        }).mount('#app');
    </script>
</body>
</html>