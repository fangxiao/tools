<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿åŠ¨ç›®æ ‡ç®¡ç† - Vue 3ç‰ˆ</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/nav.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles-vue3.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <style>
        .upload-progress {
            margin-top: 10px;
        }

        .progress-text {
            text-align: center;
            font-size: 0.9em;
            color: var(--dark-gray);
        }

        .upload-success {
            color: var(--success-color);
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
    <script src="./src/libs/html2canvas.min.js"></script>
    <script src="./src/modules/goalManagementModule.js"></script>
    <script src="./src/modules/checkInManagementModule.js"></script>
    
</head>
<body>
    <div id="app" v-cloak>
        <header>
            <h1>è¿åŠ¨ç›®æ ‡ç®¡ç†</h1>
            <div class="user-info" v-if="currentUser">
                <span>æ¬¢è¿, {{ currentUser.username }}!</span>
                <button class="btn-logout" @click="logout">é€€å‡ºç™»å½•</button>
            </div>
        </header>

        <div class="container">
            <!-- åˆ›å»ºç›®æ ‡è¡¨å• -->
            <section class="form-section">
                <h2 class="section-title">åˆ›å»ºæ–°ç›®æ ‡ 
                    <button class="btn-add" @click="showAddGoalModal()">+</button>
                </h2>
            </section>

            <!-- ç›®æ ‡åˆ—è¡¨ -->

            <!-- ç›®æ ‡åˆ—è¡¨ -->
            <section class="goals-section">
                <h2 class="section-title">æˆ‘çš„è¿åŠ¨ç›®æ ‡</h2>
                <div v-if="isLoadingGoals" class="loading">åŠ è½½ä¸­...</div>
                <div v-else-if="goals.length === 0" class="no-goals">æš‚æ— è¿åŠ¨ç›®æ ‡</div>
                <div v-else class="goals-grid">
                    <div v-for="goal in goals" :key="goal.id" class="goal-card">
                        <div class="goal-header">
                            <div class="goal-title">{{ goal.title }}{{ goal.visibility === 'private' ? ' ğŸ”' : '' }}</div>
                            <div v-if="getGoalStatusBadge(goal)" class="goal-badge" :class="'goal-badge-' + getGoalStatusBadge(goal).type">
                                {{ getGoalStatusBadge(goal).text }}
                            </div>
                        </div>
                        
                        <!-- å®Œæˆå°ç«  -->
                        <div v-if="goal.progress && goal.progress.percentage >= 100" class="stamp stamp-goal-completed" 
                             :class="{ 'single-stamp': !(goal.initial_weight && goal.current_weight && goal.target_weight && calculateWeightProgress(goal) >= 100) }">
                            è¿åŠ¨å®Œæˆ
                        </div>
                        <div v-if="goal.initial_weight && goal.current_weight && goal.target_weight && calculateWeightProgress(goal) >= 100" 
                             class="stamp stamp-weight-goal-completed" 
                             :class="{ 'single-stamp': !(goal.progress && goal.progress.percentage >= 100) }">
                            å‡é‡å®Œæˆ
                        </div>
                        
                        <div class="goal-details">
                            <div class="detail-row">
                                <div class="detail-label">ç›®æ ‡é‡:</div>
                                <div class="detail-value">{{ goal.target }} km</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">æ—¶é—´èŒƒå›´:</div>
                                <div class="detail-value">{{ formatDate(goal.start_date) }} è‡³ {{ formatDate(goal.end_date) }}</div>
                            </div>
                            
                            <div v-if="goal.initial_weight || goal.current_weight || goal.target_weight" class="detail-row">
                                <div class="detail-label">ä½“é‡ä¿¡æ¯:</div>
                                <div class="detail-value">
                                    <span v-if="goal.initial_weight">åˆå§‹: {{ goal.initial_weight }}kg</span>
                                    <span v-if="goal.current_weight"> å½“å‰: {{ goal.current_weight }}kg</span>
                                    <span v-if="goal.target_weight"> ç›®æ ‡: {{ goal.target_weight }}kg</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="goal-progress">
                            <div class="goal-progress-section">
                                <div class="progress-info">
                                    <span class="progress-label">è¿åŠ¨è¿›åº¦:</span>
                                    <span class="progress-value">{{ goal.progress.current.toFixed(1) }} / {{ goal.target }} km</span>
                                    <span class="progress-percent">({{ goal.progress.percentage.toFixed(1) }}%)</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar" :style="{ width: Math.min(goal.progress.percentage, 100) + '%' }"></div>
                                </div>
                            </div>
                            
                            <div class="goal-progress-section">
                                <div class="progress-info">
                                    <span class="progress-label">æ—¶é—´è¿›åº¦:</span>
                                    <span class="progress-value">{{ calculateTimeProgress(goal).percentage.toFixed(1) }}%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar" style="background-color: #3498db" 
                                         :style="{ width: Math.min(calculateTimeProgress(goal).percentage, 100) + '%' }"></div>
                                </div>
                            </div>
                            
                            <!-- ä½“é‡ç›®æ ‡è¿›åº¦å±•ç¤º -->
                            <div v-if="goal.initial_weight && goal.current_weight && goal.target_weight" class="goal-progress-section">
                                <div class="progress-info">
                                    <span class="progress-label">ä½“é‡è¿›åº¦:</span>
                                    <span class="progress-value">{{ calculateWeightProgressPercentage(goal).toFixed(1) }}%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar" 
                                         :style="{ 
                                             width: Math.min(100, calculateWeightProgressPercentage(goal)) + '%',
                                             backgroundColor: getWeightProgressColor(goal)
                                         }">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- è¿›åº¦è½åæé†’ -->
                            <div v-if="goal.progress.percentage < calculateTimeProgress(goal).percentage" class="reminder-banner">
                                ğŸ’¡ è¿åŠ¨è¿›åº¦è½åäºæ—¶é—´è¿›åº¦ï¼ŒåŠ æ²¹è¿åŠ¨å§ï¼
                            </div>
                            
                            <!-- ç›®æ ‡å®ŒæˆçŠ¶æ€æç¤º -->
                            <div class="goal-status-text">
                                <span v-if="goal.progress.percentage >= 100">ğŸ‰ ç›®æ ‡å·²å®Œæˆ!</span>
                                <span v-else-if="goal.progress.percentage >= 80">ğŸ’ª å¿«å®Œæˆç›®æ ‡äº†!</span>
                                <span v-else-if="goal.progress.percentage >= 50">ğŸ‘ å·²å®Œæˆä¸€åŠä»¥ä¸Š!</span>
                                <span v-else-if="goal.progress.percentage >= 30">ğŸƒâ€â™‚ï¸ åŠ æ²¹ï¼Œç»§ç»­åŠªåŠ›!</span>
                                <span v-else>ğŸš€ ä»éœ€åŠªåŠ›ï¼Œç»§ç»­åŠ æ²¹!</span>
                            </div>
                        </div>
                        
                        <div class="goal-actions">
                            <button class="btn-use" @click="showCheckInModal(goal)">æ‰“å¡</button>
                            <button class="btn-details" @click="showDetailsModal(goal)">æ‰“å¡æ˜ç»†</button>
                            <button class="btn-summary" @click="showGoalSummary(goal)">æ±‡æ€»</button>
                            <button class="btn-edit" @click="showEditGoalModal(goal)" v-if="goal.user_id == currentUser.id">ç¼–è¾‘</button>
                            <button class="btn-delete" @click="deleteGoal(goal)" v-if="goal.user_id == currentUser.id">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- æ¨¡æ€æ¡† -->
        <div v-if="modal.visible" class="modal-overlay" @click.self="closeModal">
            <div class="modal">
                <div class="modal-header">
                    <h3>{{ modal.title }}</h3>
                    <button class="modal-close" @click="closeModal">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- æ‰“å¡æ¨¡æ€æ¡† -->
                    <form v-if="modal.type === 'checkin'" @submit.prevent="submitCheckIn" id="checkin-form">
                        <input type="hidden" v-model="checkInForm.goalId">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="checkin-exercise-type">è¿åŠ¨ç±»åˆ«ï¼š</label>
                                <select id="checkin-exercise-type" v-model="checkInForm.exerciseType" required>
                                    <option value="">é€‰æ‹©è¿åŠ¨ç±»åˆ«</option>
                                    <option v-for="type in exerciseTypes" :key="type.id" :value="type.id">
                                        {{ type.name }}
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="checkin-value">è¿åŠ¨é‡ï¼š</label>
                                <input type="number" id="checkin-value" v-model.number="checkInForm.value" step="0.1" min="0" required>
                                <span id="checkin-unit">{{ getExerciseUnit(checkInForm.exerciseType) }}</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="checkin-weight">ä½“é‡ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                                <input type="number" id="checkin-weight" v-model.number="checkInForm.weight" step="0.1" min="0">
                                <span>kg</span>
                            </div>
                            <div class="form-group">
                                <label for="checkin-date">æ—¥æœŸï¼š</label>
                                <input type="date" id="checkin-date" v-model="checkInForm.date" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="checkin-note">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                                <input type="text" id="checkin-note" v-model="checkInForm.note">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="checkin-image">å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                                <input type="file" id="checkin-image" @change="handleImageUpload" accept="image/*">
                                <div v-if="checkInForm.imagePreview" class="image-preview">
                                    <img :src="checkInForm.imagePreview" alt="é¢„è§ˆå›¾ç‰‡" style="max-width: 200px; max-height: 200px;">
                                </div>
                                <div v-if="isUploadingImage" class="upload-progress">
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" :style="{ width: imageUploadProgress + '%' }"></div>
                                    </div>
                                    <div class="progress-text">{{ imageUploadProgress }}%</div>
                                </div>
                                <div v-if="checkInForm.uploadedImageUrl" class="upload-success">
                                    å›¾ç‰‡å·²ä¸Šä¼ æˆåŠŸ: {{ checkInForm.uploadedImageUrl }}
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <button type="submit" class="btn-add" :disabled="isSubmittingCheckIn">
                                    {{ isSubmittingCheckIn ? 'æäº¤ä¸­...' : 'æ‰“å¡' }}
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- åˆ›å»º/ç¼–è¾‘ç›®æ ‡æ¨¡æ€æ¡† -->
                    <form v-else-if="modal.type === 'add' || modal.type === 'edit'" @submit.prevent="modal.type === 'add' ? addGoal() : updateGoal()" id="goal-form">
                        <input type="hidden" v-model="editForm.id" v-if="modal.type === 'edit'">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="goal-title">{{ modal.type === 'add' ? 'æ–°å»º' : 'ç¼–è¾‘' }}ç›®æ ‡æ ‡é¢˜:</label>
                                <input type="text" id="goal-title" v-model="editForm.title" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="goal-target">ç›®æ ‡å€¼ (å…¬é‡Œ):</label>
                                <input type="number" id="goal-target" v-model.number="editForm.target" step="0.1" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="goal-start-date">å¼€å§‹æ—¥æœŸ:</label>
                                <input type="date" id="goal-start-date" v-model="editForm.startDate" required>
                            </div>
                            <div class="form-group">
                                <label for="goal-end-date">ç»“æŸæ—¥æœŸ:</label>
                                <input type="date" id="goal-end-date" v-model="editForm.endDate" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>ä½“é‡ç›®æ ‡ (å¯é€‰):</label>
                                <div class="weight-inputs">
                                    <div class="weight-input">
                                        <input type="number" v-model.number="editForm.initialWeight" step="0.1" min="0" placeholder="åˆå§‹ä½“é‡">
                                    </div>
                                    <div class="weight-input">
                                        <input type="number" v-model.number="editForm.targetWeight" step="0.1" min="0" placeholder="ç›®æ ‡ä½“é‡">
                                    </div>
                                    <div class="weight-input" v-if="modal.type === 'edit'">
                                        <input type="number" v-model.number="editForm.currentWeight" step="0.1" min="0" placeholder="å½“å‰ä½“é‡">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="goal-visibility">å¯è§æ€§:</label>
                                <select id="goal-visibility" v-model="editForm.visibility">
                                    <option value="private">ä»…è‡ªå·±å¯è§</option>
                                    <option value="public">å…¬å¼€</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <button type="submit" class="btn-add" :disabled="modal.type === 'add' ? isAddingGoal : isUpdatingGoal">
                                    {{ modal.type === 'add' ? (isAddingGoal ? 'åˆ›å»ºä¸­...' : 'åˆ›å»ºç›®æ ‡') : (isUpdatingGoal ? 'æ›´æ–°ä¸­...' : 'æ›´æ–°ç›®æ ‡') }}
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- æ‰“å¡æ˜ç»†æ¨¡æ€æ¡† -->
                    <div v-else-if="modal.type === 'details'">
                        <div v-if="detailRecords.length === 0">æš‚æ— æ‰“å¡è®°å½•</div>
                        <div v-else>
                            <div v-for="(records, date) in groupedDetailRecords" :key="date" class="detail-date-section">
                                <div class="detail-date-header">
                                    <h4>{{ date }} (æ€»è®¡: {{ calculateDailyTotal(records).toFixed(1) }} km)</h4>
                                </div>
                                <div class="detail-date-records">
                                    <div v-for="record in records" :key="record.id" class="detail-record">
                                        <div class="detail-record-info">
                                            <div class="detail-record-type">{{ getExerciseTypeName(record.exercise_type) }}</div>
                                            <div class="detail-record-value">{{ record.value }} {{ getExerciseUnit(record.exercise_type) }}</div>
                                        </div>
                                        <div v-if="record.note" class="detail-record-note">{{ record.note }}</div>
                                        <div v-if="record.image_path" class="detail-record-image">
                                            <a :href="'/uploads/' + record.image_path" target="_blank" class="image-link">æŸ¥çœ‹å›¾ç‰‡</a>
                                        </div>
                                        <div class="detail-record-actions">
                                            <button class="btn-edit-small" @click="showEditRecordModal(record)">ç¼–è¾‘</button>
                                            <button class="btn-delete-small" @click="deleteRecord(record)">åˆ é™¤</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç¼–è¾‘è®°å½•æ¨¡æ€æ¡† -->
                    <form v-else-if="modal.type === 'editRecord'" @submit.prevent="updateRecord" id="edit-record-form">
                        <input type="hidden" v-model="editRecordForm.id">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-record-exercise-type">è¿åŠ¨ç±»åˆ«ï¼š</label>
                                <select id="edit-record-exercise-type" v-model="editRecordForm.exerciseType" required>
                                    <option value="">é€‰æ‹©è¿åŠ¨ç±»åˆ«</option>
                                    <option v-for="type in exerciseTypes" :key="type.id" :value="type.id">
                                        {{ type.name }}
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="edit-record-value">è¿åŠ¨é‡ï¼š</label>
                                <input type="number" id="edit-record-value" v-model.number="editRecordForm.value" step="0.1" min="0" required>
                                <span id="edit-record-unit">{{ getExerciseUnit(editRecordForm.exerciseType) }}</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-record-weight">ä½“é‡ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                                <input type="number" id="edit-record-weight" v-model.number="editRecordForm.weight" step="0.1" min="0">
                                <span>kg</span>
                            </div>
                            <div class="form-group">
                                <label for="edit-record-date">æ—¥æœŸï¼š</label>
                                <input type="date" id="edit-record-date" v-model="editRecordForm.date" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-record-note">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                                <input type="text" id="edit-record-note" v-model="editRecordForm.note">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-record-image">å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                                <input type="file" id="edit-record-image" @change="handleEditRecordImageUpload" accept="image/*">
                                <div v-if="editRecordForm.imagePreview" class="image-preview">
                                    <img :src="editRecordForm.imagePreview" alt="é¢„è§ˆå›¾ç‰‡" style="max-width: 200px; max-height: 200px;">
                                </div>
                                <div v-if="isUploadingImage" class="upload-progress">
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" :style="{ width: imageUploadProgress + '%' }"></div>
                                    </div>
                                    <div class="progress-text">{{ imageUploadProgress }}%</div>
                                </div>
                                <div v-if="editRecordForm.uploadedImageUrl" class="upload-success">
                                    å›¾ç‰‡å·²ä¸Šä¼ æˆåŠŸ
                                </div>
                                <div v-if="editRecordForm.existingImageUrl" class="existing-image">
                                    <p>å½“å‰å›¾ç‰‡:</p>
                                    <a :href="'/uploads/' + editRecordForm.existingImageUrl" target="_blank" class="image-link">æŸ¥çœ‹å›¾ç‰‡</a>
                                    <button type="button" @click="deleteExistingImage" class="btn-delete-small">åˆ é™¤å›¾ç‰‡</button>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <button type="submit" class="btn-add" :disabled="isUpdatingRecord">
                                    {{ isUpdatingRecord ? 'æ›´æ–°ä¸­...' : 'æ›´æ–°è®°å½•' }}
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- æ±‡æ€»æ¨¡æ€æ¡† -->
                    <div v-else-if="modal.type === 'summary'">
                        <div class="modal-actions">
                            <button class="btn-export-image" @click="exportSummaryAsImage">ğŸ“· ç”Ÿæˆé•¿å›¾</button>
                        </div>
                        
                        <div class="summary-section">
                            <h4>ğŸ“Š è¿åŠ¨æ•°æ®ç»Ÿè®¡</h4>
                            <div class="summary-stats">
                                <div class="stat-item">
                                    <div class="stat-label">æ€»æ‰“å¡æ¬¡æ•°</div>
                                    <div class="stat-value">{{ summaryStats.totalRecords }}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">ç´¯è®¡è¿åŠ¨é‡</div>
                                    <div class="stat-value">{{ summaryStats.totalDistance.toFixed(1) }} km</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">è¿åŠ¨ç±»å‹</div>
                                    <div class="stat-value">{{ Object.keys(summaryStats.exerciseTypeStats).length }} ç§</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="summary-section" v-if="summaryStats.initialWeight || summaryStats.currentWeight || summaryStats.targetWeight">
                            <h4>âš–ï¸ ä½“é‡å˜åŒ–</h4>
                            <div class="summary-stats weight-stats">
                                <div class="stat-item" v-if="summaryStats.initialWeight">
                                    <div class="stat-label">åˆå§‹ä½“é‡</div>
                                    <div class="stat-value">{{ summaryStats.initialWeight }} kg</div>
                                </div>
                                <div class="stat-item" v-if="summaryStats.currentWeight">
                                    <div class="stat-label">å½“å‰ä½“é‡</div>
                                    <div class="stat-value">{{ summaryStats.currentWeight }} kg</div>
                                </div>
                                <div class="stat-item" v-if="summaryStats.targetWeight">
                                    <div class="stat-label">ç›®æ ‡ä½“é‡</div>
                                    <div class="stat-value">{{ summaryStats.targetWeight }} kg</div>
                                </div>
                                <div class="stat-item" v-if="summaryStats.initialWeight && summaryStats.currentWeight">
                                    <div class="stat-label">ä½“é‡å˜åŒ–</div>
                                    <div class="stat-value" :class="getWeightChangeClass(summaryStats)">
                                        {{ (summaryStats.currentWeight - summaryStats.initialWeight).toFixed(1) }} kg
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="summary-section">
                            <h4>ğŸ† è¿åŠ¨ç±»å‹åˆ†å¸ƒ</h4>
                            <div class="exercise-type-stats">
                                <div v-for="(stats, typeName) in summaryStats.exerciseTypeStats" :key="typeName" class="type-stat">
                                    <div class="type-name">{{ typeName }}</div>
                                    <div class="type-details">
                                        <span>{{ stats.count }} æ¬¡</span>
                                        <span>{{ stats.distance.toFixed(1) }} {{ stats.unit }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="summary-section">
                            <h4>ğŸ¯ ç›®æ ‡è¿›åº¦</h4>
                            <div class="goal-progress-info">
                                <div class="progress-info">
                                    <span class="progress-label">å®Œæˆåº¦:</span>
                                    <span class="progress-value">{{ summaryStats.progress.current.toFixed(1) }}/{{ summaryStats.progress.target }} km</span>
                                    <span class="progress-percent">({{ summaryStats.progress.percentage.toFixed(1)}}%)</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar" 
                                         :style="{ width: summaryStats.progress.percentage + '%' }"
                                         :class="{
                                             'progress-bar-warning': summaryStats.progress.percentage >= 80 && summaryStats.progress.percentage < 100,
                                             'progress-bar-success': summaryStats.progress.percentage >= 100
                                         }">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="summary-section" v-if="summaryStats.aiRecommendations.length > 0 || summaryStats.aiLoading">
                            <h4>ğŸ¤– AIä¸ªæ€§åŒ–å»ºè®®</h4>
                            <div class="motivational-message ai-recommendations">
                                <div v-if="summaryStats.aiLoading" class="ai-loading">
                                    æ­£åœ¨è·å–AIå»ºè®®...
                                </div>
                                <div v-for="(rec, index) in summaryStats.aiRecommendations" :key="index">
                                    {{ rec }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¡®è®¤å¯¹è¯æ¡† -->
        <div v-if="confirmDialog.visible" class="custom-confirm-overlay" @click.self="confirmDialog.onCancel">
            <div class="custom-confirm">
                <div class="custom-confirm-content">
                    <p>{{ confirmDialog.message }}</p>
                    <div class="custom-confirm-buttons">
                        <button class="btn-confirm-no" type="button" @click="confirmDialog.onCancel">å–æ¶ˆ</button>
                        <button class="btn-confirm-yes" type="button" @click="confirmDialog.onConfirm">ç¡®å®š</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æç¤ºæ¡† -->
        <div v-if="alert.visible" class="custom-alert" :class="'custom-alert-' + alert.type">
            <span class="custom-alert-message">{{ alert.message }}</span>
            <span class="custom-alert-close" @click="hideAlert">&times;</span>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted } = Vue;
        
        createApp({
            setup() {
                // çŠ¶æ€ç®¡ç†
                const isLoadingGoals = ref(false);
                const isAddingGoal = ref(false);
                const isSubmittingCheckIn = ref(false);
                const isUpdatingGoal = ref(false);
                const isUpdatingRecord = ref(false);
                const isUploadingImage = ref(false);  // æ·»åŠ å›¾ç‰‡ä¸Šä¼ çŠ¶æ€
                const imageUploadProgress = ref(0);   // æ·»åŠ å›¾ç‰‡ä¸Šä¼ è¿›åº¦
                
                // æ•°æ®
                const goals = ref([]);
                const detailRecords = ref([]);
                const currentGoal = ref(null);
                const summaryStats = reactive({
                    exerciseTypeStats: {},
                    totalDistance: 0,
                    totalRecords: 0,
                    progress: { current: 0, target: 0, percentage: 0 },
                    aiRecommendations: [],
                    aiLoading: false
                });
                const currentUser = ref(null);
                const goalProgressMap = ref({});
                
                // è¡¨å•æ•°æ®
                const newGoal = reactive({
                    period: 'monthly',
                    title: '',
                    target: 50,
                    startDate: '',
                    endDate: '',
                    initialWeight: null,
                    targetWeight: null,
                    currentWeight: null, // æ·»åŠ currentWeightå­—æ®µ
                    visibility: 'private'
                });
                
                // æ‰“å¡è¡¨å•æ•°æ®
                const checkInForm = reactive({
                    goalId: '',
                    exerciseType: 'running',
                    value: 0,
                    weight: null,
                    date: '',
                    note: '',
                    image: null,
                    imagePreview: null,
                    uploadedImageUrl: null // æ·»åŠ å·²ä¸Šä¼ å›¾ç‰‡çš„URL
                });
                
                const editForm = reactive({
                    id: null,
                    title: '',
                    target: 0,
                    startDate: '',
                    endDate: '',
                    initialWeight: null,
                    targetWeight: null,
                    currentWeight: null,
                    visibility: 'private'
                });
                
                const editRecordForm = reactive({
                    id: null,
                    exerciseType: '',
                    value: 0,
                    weight: null,
                    date: '',
                    note: '',
                    existingImageUrl: null, // ç°æœ‰çš„å›¾ç‰‡URL
                    uploadedImageUrl: null, // æ–°ä¸Šä¼ çš„å›¾ç‰‡URL
                    imagePreview: null,     // å›¾ç‰‡é¢„è§ˆ
                    deletedImage: false     // æ˜¯å¦åˆ é™¤å›¾ç‰‡æ ‡è®°
                });
                
                // æ¨¡æ€æ¡†çŠ¶æ€
                const modal = reactive({
                    visible: false,
                    type: '',
                    title: ''
                });
                
                const confirmDialog = reactive({
                    visible: false,
                    message: '',
                    onConfirm: function() {},
                    onCancel: function() {
                        confirmDialog.visible = false;
                    }
                });
                
                const alert = reactive({
                    visible: false,
                    message: '',
                    type: 'info'
                });
                
                // è¿åŠ¨ç±»å‹å®šä¹‰ï¼ˆä¸åŸç‰ˆä¿æŒä¸€è‡´ï¼‰
                const exerciseTypes = [
                    { id: 'running', name: 'è·‘æ­¥', unit: 'km' },
                    { id: 'walking', name: 'èµ°è·¯', unit: 'km' },
                    { id: 'cycling', name: 'éª‘è½¦', unit: 'km' },
                    { id: 'swimming', name: 'æ¸¸æ³³', unit: 'å°æ—¶' },
                    { id: 'boxing', name: 'æ‹³å‡»', unit: 'å°æ—¶' },
                    { id: 'rowing', name: 'åˆ’èˆ¹', unit: 'km' },
                    { id: 'climbing_stairs', name: 'çˆ¬æ¥¼æ¢¯', unit: 'å°æ—¶' },
                    { id: 'basketball', name: 'ç¯®çƒ', unit: 'å°æ—¶' },
                    { id: 'football', name: 'è¶³çƒ', unit: 'å°æ—¶' },
                    { id: 'badminton', name: 'ç¾½æ¯›çƒ', unit: 'å°æ—¶' },
                    { id: 'table_tennis', name: 'ä¹’ä¹“çƒ', unit: 'å°æ—¶' },
                    { id: 'tennis', name: 'ç½‘çƒ', unit: 'å°æ—¶' },
                    { id: 'golf', name: 'é«˜å°”å¤«', unit: 'å°æ—¶' },
                    { id: 'billiards', name: 'å°çƒ', unit: 'å°æ—¶' },
                    { id: 'weight_lifting', name: 'æ’¸é“', unit: 'å°æ—¶' },
                    { id: 'mountain_climbing', name: 'ç™»å±±', unit: 'km' }
                ];
                
                // è®¡ç®—å±æ€§
                const groupedDetailRecords = computed(() => {
                    const groups = {};
                    detailRecords.value.forEach(record => {
                        if (!groups[record.record_date]) {
                            groups[record.record_date] = [];
                        }
                        groups[record.record_date].push(record);
                    });
                    
                    // æŒ‰æ—¥æœŸæ’åº
                    return Object.keys(groups)
                        .sort()
                        .reverse()
                        .reduce((obj, key) => {
                            obj[key] = groups[key];
                            return obj;
                        }, {});
                });
                
                // æ–¹æ³•å®ç°
                const checkAuth = () => {
                    const token = localStorage.getItem('token');
                    const user = localStorage.getItem('currentUser');
                    
                    if (!token || !user) {
                        window.location.href = '/login.html';
                        return false;
                    }
                    
                    currentUser.value = JSON.parse(user);
                    return true;
                };
                
                // åˆå§‹åŒ–æ—¥æœŸå­—æ®µ
                const initDateFields = () => {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const todayStr = `${year}-${month}-${day}`;
                    
                    if (!newGoal.startDate) {
                        newGoal.startDate = todayStr;
                    }
                    
                    if (!newGoal.endDate) {
                        const nextMonth = new Date();
                        nextMonth.setMonth(nextMonth.getMonth() + 1);
                        const nextYear = nextMonth.getFullYear();
                        const nextMonthStr = String(nextMonth.getMonth() + 1).padStart(2, '0');
                        const nextDay = String(nextMonth.getDate()).padStart(2, '0');
                        newGoal.endDate = `${nextYear}-${nextMonthStr}-${nextDay}`;
                    }
                    
                    // åˆå§‹åŒ–ç¼–è¾‘è¡¨å•çš„æ—¥æœŸ
                    if (!editForm.startDate) {
                        editForm.startDate = todayStr;
                    }
                    
                    if (!editForm.endDate) {
                        const nextMonth = new Date();
                        nextMonth.setMonth(nextMonth.getMonth() + 1);
                        const nextYear = nextMonth.getFullYear();
                        const nextMonthStr = String(nextMonth.getMonth() + 1).padStart(2, '0');
                        const nextDay = String(nextMonth.getDate()).padStart(2, '0');
                        editForm.endDate = `${nextYear}-${nextMonthStr}-${nextDay}`;
                    }
                };
                
                const updateDateFields = () => {
                    initDateFields();
                };
                
                const updateGoalTitle = () => {
                    const today = new Date();
                    
                    switch (newGoal.period) {
                        case 'none':
                            newGoal.title = 'è‡ªå®šä¹‰è¿åŠ¨ç›®æ ‡';
                            break;
                        case 'monthly':
                            newGoal.title = today.getFullYear() + 'å¹´' + (today.getMonth() + 1) + 'æœˆè¿åŠ¨ç›®æ ‡';
                            break;
                        case 'weekly':
                            const weekNumber = getWeekNumber(today);
                            newGoal.title = today.getFullYear() + 'å¹´ç¬¬' + weekNumber + 'å‘¨è¿åŠ¨ç›®æ ‡';
                            break;
                        case 'daily':
                            newGoal.title = today.getFullYear() + 'å¹´' + (today.getMonth() + 1) + 'æœˆ' + today.getDate() + 'æ—¥è¿åŠ¨ç›®æ ‡';
                            break;
                    }
                };
                
                const getWeekNumber = (date) => {
                    const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
                    const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
                    return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
                };
                
                const formatDateForInput = (date) => {
                    return date.toISOString().split('T')[0];
                };
                
                const formatDate = (dateString) => {
                    const date = new Date(dateString);
                    return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
                };
                
                const fetchGoals = async () => {
                    if (!checkAuth()) return;
                    
                    isLoadingGoals.value = true;
                    try {
                        // è®¾ç½®å½“å‰ç”¨æˆ·
                        window.GoalManagementModule.setCurrentUser(currentUser.value);
                        
                        // è·å–ç›®æ ‡åˆ—è¡¨
                        const goalsData = await window.GoalManagementModule.fetchGoals();
                        
                        // è·å–æ‰€æœ‰ç›®æ ‡çš„è¿›åº¦
                        const progressPromises = goalsData.map(goal => 
                            fetch('/api/exercise-records?userId=' + currentUser.value.id)
                                .then(response => response.json())
                                .then(records => {
                                    const progress = calculateGoalProgress(goal, records);
                                    goalProgressMap.value[goal.id] = progress;
                                    return { ...goal, progress };
                                })
                        );
                        
                        goals.value = await Promise.all(progressPromises);
                    } catch (error) {
                        console.error('è·å–ç›®æ ‡åˆ—è¡¨æ—¶å‡ºé”™:', error);
                        showAlert('è·å–ç›®æ ‡åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
                    } finally {
                        isLoadingGoals.value = false;
                    }
                };
                
                const calculateGoalProgress = (goal, records) => {
                    return window.GoalManagementModule.calculateGoalProgress(goal, records, exerciseTypes);
                };
                
                const calculateTimeProgress = (goal) => {
                    return window.GoalManagementModule.calculateTimeProgress(goal);
                };
                
                const getPeriodText = (period) => {
                    return window.GoalManagementModule.getPeriodText(period);
                };
                
                const getGoalStatusBadge = (goal) => {
                    return window.GoalManagementModule.getGoalStatusBadge(goal, calculateTimeProgress);
                };
                
                // æ˜¾ç¤ºæ·»åŠ ç›®æ ‡æ¨¡æ€æ¡†
                const showAddGoalModal = () => {
                    // é‡ç½®è¡¨å•æ•°æ®
                    editForm.id = null;
                    editForm.title = '';
                    editForm.target = '';
                    editForm.startDate = '';
                    editForm.endDate = '';
                    editForm.initialWeight = '';
                    editForm.targetWeight = '';
                    editForm.currentWeight = '';
                    editForm.visibility = 'private';
                    
                    // è®¾ç½®æ¨¡æ€æ¡†çŠ¶æ€
                    modal.type = 'add';
                    modal.title = 'åˆ›å»ºæ–°ç›®æ ‡';
                    modal.visible = true;
                };

                // æ˜¾ç¤ºç¼–è¾‘ç›®æ ‡æ¨¡æ€æ¡†
                const showEditGoalModal = (goal) => {
                    // å¡«å……è¡¨å•æ•°æ®
                    editForm.id = goal.id;
                    editForm.title = goal.title;
                    editForm.target = goal.target;
                    editForm.startDate = goal.start_date;
                    editForm.endDate = goal.end_date;
                    editForm.initialWeight = goal.initial_weight;
                    editForm.targetWeight = goal.target_weight;
                    editForm.currentWeight = goal.current_weight;
                    editForm.visibility = goal.visibility;
                    
                    // è®¾ç½®æ¨¡æ€æ¡†çŠ¶æ€
                    modal.type = 'edit';
                    modal.title = 'ç¼–è¾‘ç›®æ ‡';
                    modal.visible = true;
                };

                // æ·»åŠ ç›®æ ‡
                const addGoal = async () => {
                    if (!checkAuth()) return;
                    
                    isAddingGoal.value = true;
                    try {
                        const goalData = {
                            title: editForm.title,
                            target: parseFloat(editForm.target),
                            period: 'custom', // æ·»åŠ periodå­—æ®µï¼Œé»˜è®¤ä¸ºcustom
                            startDate: editForm.startDate,
                            endDate: editForm.endDate,
                            initialWeight: editForm.initialWeight ? parseFloat(editForm.initialWeight) : null,
                            targetWeight: editForm.targetWeight ? parseFloat(editForm.targetWeight) : null,
                            visibility: editForm.visibility,
                            user_id: currentUser.value.id
                        };
                        
                        const response = await fetch(`/api/exercise-goals?userId=${currentUser.value.id}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(goalData)
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                        }
                        
                        showAlert('ç›®æ ‡åˆ›å»ºæˆåŠŸï¼', 'success');
                        closeModal();
                        await fetchGoals();
                    } catch (error) {
                        console.error('åˆ›å»ºç›®æ ‡æ—¶å‡ºé”™:', error);
                        showAlert('åˆ›å»ºç›®æ ‡å¤±è´¥: ' + error.message, 'error');
                    } finally {
                        isAddingGoal.value = false;
                    }
                };

                // æ›´æ–°ç›®æ ‡
                const updateGoal = async () => {
                    if (!checkAuth()) return;
                    
                    isUpdatingGoal.value = true;
                    try {
                        const goalData = {
                            title: editForm.title,
                            target: parseFloat(editForm.target),
                            period: 'custom', // æ·»åŠ periodå­—æ®µ
                            startDate: editForm.startDate,
                            endDate: editForm.endDate,
                            initialWeight: editForm.initialWeight ? parseFloat(editForm.initialWeight) : null,
                            targetWeight: editForm.targetWeight ? parseFloat(editForm.targetWeight) : null,
                            currentWeight: editForm.currentWeight ? parseFloat(editForm.currentWeight) : null,
                            visibility: editForm.visibility
                        };
                        
                        const response = await fetch(`/api/exercise-goals/${editForm.id}?userId=${currentUser.value.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(goalData)
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                        }
                        
                        showAlert('ç›®æ ‡æ›´æ–°æˆåŠŸï¼', 'success');
                        closeModal();
                        await fetchGoals();
                    } catch (error) {
                        console.error('æ›´æ–°ç›®æ ‡æ—¶å‡ºé”™:', error);
                        showAlert('æ›´æ–°ç›®æ ‡å¤±è´¥: ' + error.message, 'error');
                    } finally {
                        isUpdatingGoal.value = false;
                    }
                };
                
                const getGoalStatus = (goal) => {
                    const progress = goal.progress;
                    const timeProgress = calculateTimeProgress(goal);
                    
                    if (progress.isCompleted) return 'completed';
                    if (timeProgress.percentage > progress.percentage) return 'behind';
                    if (timeProgress.percentage <= progress.percentage) return 'ahead';
                    return 'normal';
                };
                
                const getGoalStatusLabel = (goal) => {
                    const status = getGoalStatus(goal);
                    switch (status) {
                        case 'completed': return 'âœ… å·²å®Œæˆ';
                        case 'behind': return 'âš ï¸ è¿›åº¦è½å';
                        case 'ahead': return 'ğŸš€ è¶…å‰å®Œæˆ';
                        default: return 'ğŸƒ è¿›è¡Œä¸­';
                    }
                };
                
                const calculateWeightProgressPercentage = (goal) => {
                    if (!goal.initial_weight || !goal.target_weight) return 0;
                    
                    const initial = goal.initial_weight;
                    const target = goal.target_weight;
                    const current = goal.current_weight || initial;
                    
                    // è®¡ç®—ä½“é‡ç›®æ ‡å®Œæˆç™¾åˆ†æ¯”
                    if (initial > target) {
                        // å‡é‡ç›®æ ‡
                        const totalLoss = initial - target;
                        const currentLoss = initial - current;
                        return Math.min(Math.max((currentLoss / totalLoss) * 100, 0), 100);
                    } else {
                        // å¢é‡ç›®æ ‡
                        const totalGain = target - initial;
                        const currentGain = current - initial;
                        return Math.min(Math.max((currentGain / totalGain) * 100, 0), 100);
                    }
                };
                
                const calculateWeightProgress = (goal) => {
                    return calculateWeightProgressPercentage(goal);
                };
                
                const getWeightProgressColor = (goal) => {
                    const progress = calculateWeightProgress(goal);
                    if (progress >= 100) return '#2ecc71'; // green
                    if (goal.initial_weight > goal.target_weight) {
                        // å‡é‡ç›®æ ‡
                        return goal.current_weight <= goal.target_weight ? '#2ecc71' : '#e74c3c'; // green if reached, red if not
                    } else {
                        // å¢é‡ç›®æ ‡
                        return goal.current_weight >= goal.target_weight ? '#2ecc71' : '#e74c3c'; // green if reached, red if not
                    }
                };
                
                const getExerciseTypeName = (typeId) => {
                    const type = exerciseTypes.find(t => t.id === typeId);
                    return type ? type.name : 'æœªçŸ¥ç±»å‹';
                };
                
                const getExerciseUnit = (typeId) => {
                    const type = exerciseTypes.find(t => t.id === typeId);
                    return type ? type.unit : 'å•ä½';
                };
                
                const showCheckInModal = (goal) => {
                    checkInForm.goalId = goal.id;
                    checkInForm.exerciseType = 'running';
                    checkInForm.value = 0;
                    checkInForm.weight = null;
                    checkInForm.date = new Date().toISOString().split('T')[0];
                    checkInForm.note = '';
                    checkInForm.image = null;
                    checkInForm.imagePreview = null;
                    checkInForm.uploadedImageUrl = null; // é‡ç½®å·²ä¸Šä¼ å›¾ç‰‡URL
                    
                    modal.type = 'checkin';
                    modal.title = `æ‰“å¡ - ${goal.title}`;
                    modal.visible = true;
                };

                // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
                const handleImageUpload = async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§10MBï¼‰
                        if (file.size > 10 * 1024 * 1024) {
                            showAlert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB', 'error');
                            event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                            return;
                        }

                        // æ£€æŸ¥æ–‡ä»¶ç±»å‹ - ä¸åç«¯ä¿æŒä¸€è‡´ï¼Œåªè¦æ˜¯image/å¼€å¤´çš„MIMEç±»å‹éƒ½å¯ä»¥
                        if (!file.type.startsWith('image/')) {
                            showAlert('åªæ”¯æŒå›¾ç‰‡æ–‡ä»¶', 'error');
                            event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                            return;
                        }

                        // ç”Ÿæˆé¢„è§ˆ
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            checkInForm.imagePreview = e.target.result;
                        };
                        reader.readAsDataURL(file);

                        // ç«‹å³ä¸Šä¼ å›¾ç‰‡
                        isUploadingImage.value = true;
                        imageUploadProgress.value = 0;
                        
                        try {
                            const formData = new FormData();
                            formData.append('image', file);

                            const xhr = new XMLHttpRequest();
                            
                            // ç›‘å¬ä¸Šä¼ è¿›åº¦
                            xhr.upload.addEventListener('progress', (e) => {
                                if (e.lengthComputable) {
                                    imageUploadProgress.value = Math.round((e.loaded / e.total) * 100);
                                }
                            });

                            // åˆ›å»ºPromiseæ¥å¤„ç†å¼‚æ­¥ä¸Šä¼ 
                            const uploadPromise = new Promise((resolve, reject) => {
                                xhr.onload = () => {
                                    if (xhr.status === 200) {
                                        const response = JSON.parse(xhr.responseText);
                                        resolve(response.imageUrl);
                                    } else {
                                        try {
                                            const errorResponse = JSON.parse(xhr.responseText);
                                            reject(new Error(errorResponse.error || 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥'));
                                        } catch (e) {
                                            reject(new Error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥'));
                                        }
                                    }
                                };
                                
                                xhr.onerror = () => {
                                    reject(new Error('ç½‘ç»œé”™è¯¯'));
                                };
                            });

                            // å‘é€è¯·æ±‚
                            xhr.open('POST', `/api/upload-image?userId=${currentUser.value.id}`);
                            xhr.send(formData);

                            // ç­‰å¾…ä¸Šä¼ å®Œæˆ
                            checkInForm.uploadedImageUrl = await uploadPromise;
                            checkInForm.image = file;
                            showAlert('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
                        } catch (error) {
                            console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                            showAlert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
                            event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                            checkInForm.image = null;
                            checkInForm.imagePreview = null;
                            checkInForm.uploadedImageUrl = null;
                        } finally {
                            isUploadingImage.value = false;
                            imageUploadProgress.value = 0;
                        }
                    } else {
                        checkInForm.image = null;
                        checkInForm.imagePreview = null;
                        checkInForm.uploadedImageUrl = null;
                    }
                };

                // å¤„ç†ç¼–è¾‘è®°å½•æ—¶çš„å›¾ç‰‡ä¸Šä¼ 
                const handleEditRecordImageUpload = async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§10MBï¼‰
                        if (file.size > 10 * 1024 * 1024) {
                            showAlert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB', 'error');
                            event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                            return;
                        }

                        // æ£€æŸ¥æ–‡ä»¶ç±»å‹ - ä¸åç«¯ä¿æŒä¸€è‡´ï¼Œåªè¦æ˜¯image/å¼€å¤´çš„MIMEç±»å‹éƒ½å¯ä»¥
                        if (!file.type.startsWith('image/')) {
                            showAlert('åªæ”¯æŒå›¾ç‰‡æ–‡ä»¶', 'error');
                            event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                            return;
                        }

                        // ç”Ÿæˆé¢„è§ˆ
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            editRecordForm.imagePreview = e.target.result;
                        };
                        reader.readAsDataURL(file);

                        // ç«‹å³ä¸Šä¼ å›¾ç‰‡
                        isUploadingImage.value = true;
                        imageUploadProgress.value = 0;
                        
                        try {
                            const formData = new FormData();
                            formData.append('image', file);

                            const xhr = new XMLHttpRequest();
                            
                            // ç›‘å¬ä¸Šä¼ è¿›åº¦
                            xhr.upload.addEventListener('progress', (e) => {
                                if (e.lengthComputable) {
                                    imageUploadProgress.value = Math.round((e.loaded / e.total) * 100);
                                }
                            });

                            // åˆ›å»ºPromiseæ¥å¤„ç†å¼‚æ­¥ä¸Šä¼ 
                            const uploadPromise = new Promise((resolve, reject) => {
                                xhr.onload = () => {
                                    if (xhr.status === 200) {
                                        const response = JSON.parse(xhr.responseText);
                                        resolve(response.imageUrl);
                                    } else {
                                        try {
                                            const errorResponse = JSON.parse(xhr.responseText);
                                            reject(new Error(errorResponse.error || 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥'));
                                        } catch (e) {
                                            reject(new Error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥'));
                                        }
                                    }
                                };
                                
                                xhr.onerror = () => {
                                    reject(new Error('ç½‘ç»œé”™è¯¯'));
                                };
                            });

                            // å‘é€è¯·æ±‚
                            xhr.open('POST', `/api/upload-image?userId=${currentUser.value.id}`);
                            xhr.send(formData);

                            // ç­‰å¾…ä¸Šä¼ å®Œæˆ
                            editRecordForm.uploadedImageUrl = await uploadPromise;
                            showAlert('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
                        } catch (error) {
                            console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                            showAlert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
                            event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                            editRecordForm.imagePreview = null;
                            editRecordForm.uploadedImageUrl = null;
                        } finally {
                            isUploadingImage.value = false;
                            imageUploadProgress.value = 0;
                        }
                    } else {
                        editRecordForm.imagePreview = null;
                        editRecordForm.uploadedImageUrl = null;
                    }
                };

                // åˆ é™¤ç°æœ‰å›¾ç‰‡
                const deleteExistingImage = () => {
                    editRecordForm.existingImageUrl = null;
                    editRecordForm.deletedImage = true;
                    showAlert('å›¾ç‰‡æ ‡è®°ä¸ºåˆ é™¤ï¼Œä¿å­˜åç”Ÿæ•ˆ', 'info');
                };

                // æäº¤æ‰“å¡
                const submitCheckIn = async () => {
                    if (!checkAuth()) return;
                    
                    isSubmittingCheckIn.value = true;
                    try {
                        // å‡†å¤‡æ‰“å¡æ•°æ®
                        const recordData = {
                            goalId: checkInForm.goalId,
                            exerciseType: checkInForm.exerciseType,
                            value: checkInForm.value,
                            recordDate: checkInForm.date,
                            note: checkInForm.note,
                            imagePath: checkInForm.uploadedImageUrl || null
                        };
                        
                        if (checkInForm.weight) {
                            recordData.weight = checkInForm.weight;
                        }

                        const response = await fetch(`/api/exercise-records?userId=${currentUser.value.id}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(recordData)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                        }

                        showAlert('æ‰“å¡æˆåŠŸï¼', 'success');
                        closeModal();
                        
                        // æ¸…ç©ºå›¾ç‰‡ä¸Šä¼ ç›¸å…³å­—æ®µ
                        checkInForm.image = null;
                        checkInForm.imagePreview = null;
                        checkInForm.uploadedImageUrl = null;
                        
                        // å¦‚æœæœ‰ä½“é‡æ•°æ®ï¼Œåˆ™æ›´æ–°ç›®æ ‡çš„å½“å‰ä½“é‡
                        if (checkInForm.weight) {
                            await updateGoalCurrentWeight(checkInForm.goalId, checkInForm.weight);
                        }
                        
                        // åˆ·æ–°æ•°æ®
                        await fetchGoals();
                    } catch (error) {
                        console.error('æ‰“å¡æ—¶å‡ºé”™:', error);
                        showAlert('æ‰“å¡å¤±è´¥: ' + error.message, 'error');
                    } finally {
                        isSubmittingCheckIn.value = false;
                    }
                };
                
                const showDetailsModal = async (goal) => {
                    try {
                        // ä½¿ç”¨æ‰“å¡ç®¡ç†æ¨¡å—è·å–æ‰“å¡æ˜ç»†
                        window.CheckInManagementModule.setCurrentUser(currentUser.value);
                        detailRecords.value = await window.CheckInManagementModule.getCheckInDetails(goal.id);
                        
                        modal.visible = true;
                        modal.type = 'details';
                        modal.title = 'æ‰“å¡æ˜ç»† - ' + goal.title;
                    } catch (error) {
                        console.error('è·å–æ‰“å¡æ˜ç»†æ—¶å‡ºé”™:', error);
                        showAlert('åŠ è½½è¿åŠ¨è®°å½•å¤±è´¥: ' + error.message, 'error');
                    }
                };
                
                const showEditRecordModal = async (record) => {
                    try {
                        // ä½¿ç”¨æ‰“å¡ç®¡ç†æ¨¡å—è·å–è®°å½•è¯¦æƒ…
                        window.CheckInManagementModule.setCurrentUser(currentUser.value);
                        const recordDetails = await window.CheckInManagementModule.getRecordDetails(record.id);
                        
                        editRecordForm.id = recordDetails.id;
                        editRecordForm.exerciseType = recordDetails.exercise_type;
                        editRecordForm.value = recordDetails.value;
                        editRecordForm.weight = recordDetails.weight;
                        editRecordForm.date = recordDetails.record_date;
                        editRecordForm.note = recordDetails.note;
                        editRecordForm.existingImageUrl = recordDetails.image_path || null; // åŠ è½½ç°æœ‰å›¾ç‰‡è·¯å¾„
                        editRecordForm.uploadedImageUrl = null; // æ¸…ç©ºæ–°ä¸Šä¼ çš„å›¾ç‰‡
                        editRecordForm.imagePreview = null; // æ¸…ç©ºé¢„è§ˆ
                        editRecordForm.deletedImage = false; // é‡ç½®åˆ é™¤æ ‡è®°
                        
                        modal.visible = true;
                        modal.type = 'editRecord';
                        modal.title = 'ç¼–è¾‘è¿åŠ¨è®°å½•';
                    } catch (error) {
                        console.error('è·å–è®°å½•è¯¦æƒ…æ—¶å‡ºé”™:', error);
                        showAlert('åŠ è½½è¿åŠ¨è®°å½•è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
                    }
                };
                
                const updateRecord = async () => {
                    if (!checkAuth()) return;
                    
                    isUpdatingRecord.value = true;
                    try {
                        // å‡†å¤‡è®°å½•æ•°æ®
                        const recordData = {
                            exerciseType: editRecordForm.exerciseType,
                            value: editRecordForm.value,
                            recordDate: editRecordForm.date,
                            note: editRecordForm.note
                        };
                        
                        // å¤„ç†å›¾ç‰‡
                        if (editRecordForm.deletedImage) {
                            // å¦‚æœæ ‡è®°ä¸ºåˆ é™¤å›¾ç‰‡ï¼Œåˆ™è®¾ç½®imagePathä¸ºnull
                            recordData.imagePath = null;
                        } else if (editRecordForm.uploadedImageUrl) {
                            // å¦‚æœæœ‰æ–°ä¸Šä¼ çš„å›¾ç‰‡ï¼Œåˆ™ä½¿ç”¨æ–°å›¾ç‰‡
                            recordData.imagePath = editRecordForm.uploadedImageUrl;
                        } else if (editRecordForm.existingImageUrl) {
                            // å¦‚æœä¿ç•™ç°æœ‰å›¾ç‰‡ï¼Œåˆ™ç»§ç»­ä½¿ç”¨ç°æœ‰å›¾ç‰‡
                            recordData.imagePath = editRecordForm.existingImageUrl;
                        }
                        
                        // ä½¿ç”¨æ‰“å¡ç®¡ç†æ¨¡å—æ›´æ–°è®°å½•
                        window.CheckInManagementModule.setCurrentUser(currentUser.value);
                        await window.CheckInManagementModule.updateRecord(editRecordForm.id, recordData);
                        
                        // å¦‚æœæä¾›äº†ä½“é‡ï¼Œæ›´æ–°ç›®æ ‡çš„å½“å‰ä½“é‡
                        if (editRecordForm.weight !== null && !isNaN(editRecordForm.weight)) {
                            // è·å–è®°å½•å…³è”çš„ç›®æ ‡ID
                            const recordDetails = await window.CheckInManagementModule.getRecordDetails(editRecordForm.id);
                            if (recordDetails) {
                                await window.CheckInManagementModule.updateGoalWeight(recordDetails.goal_id, editRecordForm.weight);
                            }
                        }
                        
                        showAlert('è®°å½•æ›´æ–°æˆåŠŸï¼', 'success');
                        closeModal();
                        
                        // åˆ·æ–°æ˜ç»†è§†å›¾
                        if (modal.visible && modal.type === 'details') {
                            const currentGoalId = checkInForm.goalId;
                            const currentGoal = goals.value.find(g => g.id == currentGoalId);
                            if (currentGoal) {
                                showDetailsModal(currentGoal);
                            }
                        }
                        
                        // æ›´æ–°ç›®æ ‡åˆ—è¡¨
                        await fetchGoals();
                    } catch (error) {
                        console.error('æ›´æ–°è®°å½•æ—¶å‡ºé”™:', error);
                        showAlert('æ›´æ–°è®°å½•å¤±è´¥: ' + error.message, 'error');
                    } finally {
                        isUpdatingRecord.value = false;
                    }
                };
                
                const deleteRecord = (record) => {
                    showConfirm(
                        'ç¡®è®¤åˆ é™¤',
                        'ç¡®å®šè¦åˆ é™¤è¿™æ¡æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼',
                        async () => {
                            try {
                                // ä½¿ç”¨æ‰“å¡ç®¡ç†æ¨¡å—åˆ é™¤è®°å½•
                                window.CheckInManagementModule.setCurrentUser(currentUser.value);
                                await window.CheckInManagementModule.deleteRecord(record.id);
                                
                                showAlert('æ‰“å¡è®°å½•åˆ é™¤æˆåŠŸï¼', 'success');
                                // åˆ·æ–°æ˜ç»†è§†å›¾
                                if (modal.visible && modal.type === 'details') {
                                    // è·å–å½“å‰è¯¦æƒ…é¡µé¢å¯¹åº”çš„ç›®æ ‡
                                    const goalId = detailRecords.value.length > 0 ? detailRecords.value[0].goal_id : null;
                                    if (goalId) {
                                        const currentGoal = goals.value.find(g => g.id == goalId);
                                        if (currentGoal) {
                                            showDetailsModal(currentGoal);
                                        }
                                    }
                                }
                                // æ›´æ–°ç›®æ ‡åˆ—è¡¨
                                await fetchGoals();
                            } catch (error) {
                                console.error('åˆ é™¤è®°å½•æ—¶å‡ºé”™:', error);
                                showAlert('åˆ é™¤æ‰“å¡è®°å½•å¤±è´¥: ' + error.message, 'error');
                            }
                        }
                    );
                };
                
                // ç”Ÿæˆæ±‡æ€»å›¾ç‰‡
                const exportSummaryAsImage = async () => {
                    try {
                        // æ˜¾ç¤ºæ­£åœ¨ç”Ÿæˆæç¤º
                        showAlert('æ­£åœ¨ç”Ÿæˆé•¿å›¾...', 'info');
                        
                        // ç­‰å¾…æç¤ºæ˜¾ç¤º
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        // åˆ›å»ºç”¨äºå¯¼å‡ºçš„ä¸´æ—¶å®¹å™¨
                        const exportContainer = document.createElement('div');
                        exportContainer.className = 'summary-export-container';
                        exportContainer.innerHTML = `
                            <div style="font-family: Arial, sans-serif; max-width: 800px; background: white;">
                                <h2 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">${currentGoal.value ? currentGoal.value.title : 'è¿åŠ¨ç›®æ ‡æ±‡æ€»'}</h2>
                                
                                <div style="margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 14px; color: #6c757d;">æ€»æ‰“å¡æ¬¡æ•°</div>
                                        <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">${summaryStats.totalRecords}</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 14px; color: #6c757d;">ç´¯è®¡è¿åŠ¨é‡</div>
                                        <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">${summaryStats.totalDistance.toFixed(1)} km</div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 14px; color: #6c757d;">è¿åŠ¨ç±»å‹</div>
                                        <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">${Object.keys(summaryStats.exerciseTypeStats).length} ç§</div>
                                    </div>
                                </div>
                                
                                ${summaryStats.initialWeight || summaryStats.currentWeight || summaryStats.targetWeight ? `
                                <div style="margin-bottom: 20px;">
                                    <h3 style="color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px;">âš–ï¸ ä½“é‡å˜åŒ–</h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                                        ${summaryStats.initialWeight ? `
                                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                            <div style="font-size: 14px; color: #6c757d;">åˆå§‹ä½“é‡</div>
                                            <div style="font-size: 20px; font-weight: bold; color: #2c3e50;">${summaryStats.initialWeight} kg</div>
                                        </div>` : ''}
                                        ${summaryStats.currentWeight ? `
                                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                            <div style="font-size: 14px; color: #6c757d;">å½“å‰ä½“é‡</div>
                                            <div style="font-size: 20px; font-weight: bold; color: #2c3e50;">${summaryStats.currentWeight} kg</div>
                                        </div>` : ''}
                                        ${summaryStats.targetWeight ? `
                                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                            <div style="font-size: 14px; color: #6c757d;">ç›®æ ‡ä½“é‡</div>
                                            <div style="font-size: 20px; font-weight: bold; color: #2c3e50;">${summaryStats.targetWeight} kg</div>
                                        </div>` : ''}
                                        ${(summaryStats.initialWeight && summaryStats.currentWeight) ? `
                                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                            <div style="font-size: 14px; color: #6c757d;">ä½“é‡å˜åŒ–</div>
                                            <div style="font-size: 20px; font-weight: bold; color: ${getWeightChangeColor(summaryStats)};">
                                                ${(summaryStats.currentWeight - summaryStats.initialWeight).toFixed(1)} kg
                                            </div>
                                        </div>` : ''}
                                    </div>
                                </div>` : ''}
                                
                                <div style="margin-bottom: 20px;">
                                    <h3 style="color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px;">ğŸ† è¿åŠ¨ç±»å‹åˆ†å¸ƒ</h3>
                                    <div style="display: grid; gap: 10px;">
                                        ${Object.entries(summaryStats.exerciseTypeStats).map(([typeName, stats]) => `
                                            <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                                <span>${typeName}</span>
                                                <span>${stats.count} æ¬¡ Â· ${stats.distance.toFixed(1)} ${stats.unit}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <h3 style="color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px;">ğŸ¯ ç›®æ ‡è¿›åº¦</h3>
                                    <div style="margin-bottom: 10px;">
                                        <span style="font-weight: bold;">å®Œæˆåº¦: </span>
                                        <span>${summaryStats.progress.current.toFixed(1)}/${summaryStats.progress.target} km</span>
                                        <span style="margin-left: 10px;">(${summaryStats.progress.percentage.toFixed(1)}%)</span>
                                    </div>
                                    <div style="height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden;">
                                        <div style="height: 100%; width: ${Math.min(summaryStats.progress.percentage, 100)}%; 
                                            background: ${summaryStats.progress.percentage >= 100 ? '#28a745' : summaryStats.progress.percentage >= 80 ? '#ffc107' : '#007bff'}; 
                                            border-radius: 10px;"></div>
                                    </div>
                                </div>
                                
                                ${summaryStats.aiRecommendations.length > 0 ? `
                                <div>
                                    <h3 style="color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px;">ğŸ¤– AIä¸ªæ€§åŒ–å»ºè®®</h3>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                        ${summaryStats.aiRecommendations.map(rec => `<div style="margin-bottom: 10px;">â€¢ ${rec}</div>`).join('')}
                                    </div>
                                </div>` : ''}
                            </div>
                        `;
                        
                        document.body.appendChild(exportContainer);
                        
                        // ä½¿ç”¨html2canvasç”Ÿæˆå›¾ç‰‡
                        const canvas = await html2canvas(exportContainer, {
                            scale: 2, // æé«˜å›¾ç‰‡è´¨é‡
                            useCORS: true,
                            backgroundColor: '#ffffff'
                        });
                        
                        // ç§»é™¤ä¸´æ—¶å®¹å™¨
                        document.body.removeChild(exportContainer);
                        
                        // åˆ›å»ºä¸‹è½½é“¾æ¥
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/png');
                        link.download = `è¿åŠ¨ç›®æ ‡æ±‡æ€»_${new Date().toLocaleDateString()}.png`;
                        link.click();
                        
                        showAlert('é•¿å›¾ç”ŸæˆæˆåŠŸï¼', 'success');
                    } catch (error) {
                        console.error('ç”Ÿæˆé•¿å›¾å¤±è´¥:', error);
                        showAlert('ç”Ÿæˆé•¿å›¾å¤±è´¥: ' + error.message, 'error');
                    }
                };
                
                // è·å–ä½“é‡å˜åŒ–é¢œè‰²
                const getWeightChangeColor = (stats) => {
                    if (!stats.initialWeight || !stats.currentWeight) return '#2c3e50';
                    
                    const change = stats.currentWeight - stats.initialWeight;
                    // å¦‚æœæ˜¯å‡é‡ç›®æ ‡
                    if (stats.initialWeight > stats.targetWeight) {
                        return change <= 0 ? '#28a745' : '#dc3545';
                    } 
                    // å¦‚æœæ˜¯å¢é‡ç›®æ ‡
                    else if (stats.initialWeight < stats.targetWeight) {
                        return change >= 0 ? '#28a745' : '#dc3545';
                    }
                    return '#2c3e50';
                };
                
                const showGoalSummary = async (goal) => {
                    try {
                        const [goalsResponse, recordsResponse] = await Promise.all([
                            fetch('/api/exercise-goals?userId=' + currentUser.value.id),
                            fetch('/api/exercise-records?userId=' + currentUser.value.id)
                        ]);
                        
                        if (!goalsResponse.ok || !recordsResponse.ok) {
                            throw new Error('è·å–æ•°æ®å¤±è´¥');
                        }
                        
                        const [allGoals, allRecords] = await Promise.all([
                            goalsResponse.json(),
                            recordsResponse.json()
                        ]);
                        
                        const goalRecords = allRecords.filter(record => record.goal_id == goal.id);
                        
                        // åˆ†æè¿åŠ¨ç±»å‹ç»Ÿè®¡
                        const exerciseTypeStats = {};
                        let totalDistance = 0;
                        let totalRecords = goalRecords.length;
                        
                        goalRecords.forEach(record => {
                            const exerciseType = exerciseTypes.find(type => type.id === record.exercise_type);
                            const typeName = exerciseType ? exerciseType.name : 'æœªçŸ¥ç±»å‹';
                            const unit = exerciseType ? exerciseType.unit : 'km';
                            
                            // è®°å½•åŸå§‹å€¼è€Œéè½¬æ¢åçš„å€¼
                            let rawValue = record.value;
                            
                            if (!exerciseTypeStats[typeName]) {
                                exerciseTypeStats[typeName] = {
                                    count: 0,
                                    distance: 0,
                                    unit: unit
                                };
                            }
                            
                            exerciseTypeStats[typeName].count++;
                            exerciseTypeStats[typeName].distance += rawValue;
                            // ç´¯è®¡è·ç¦»ä»ç„¶ä½¿ç”¨è½¬æ¢åçš„å€¼
                            totalDistance += convertToDistance(record);
                        });
                        
                        // è®¡ç®—ç›®æ ‡è¿›åº¦
                        const progress = calculateGoalProgress(goal, allRecords);
                        
                        // æ›´æ–°æ±‡æ€»ç»Ÿè®¡
                        summaryStats.exerciseTypeStats = exerciseTypeStats;
                        summaryStats.totalDistance = totalDistance;
                        summaryStats.totalRecords = totalRecords;
                        summaryStats.progress = progress;
                        summaryStats.initialWeight = goal.initial_weight;
                        summaryStats.currentWeight = goal.current_weight;
                        summaryStats.targetWeight = goal.target_weight;
                        currentGoal.value = goal;
                        
                        // æ˜¾ç¤ºæ¨¡æ€æ¡†
                        modal.visible = true;
                        modal.type = 'summary';
                        modal.title = 'è¿åŠ¨æ±‡æ€» - ' + goal.title;
                        
                        // å¼‚æ­¥åŠ è½½AIå»ºè®®
                        loadAIRecommendations(goal, totalRecords, totalDistance, exerciseTypeStats, progress);
                    } catch (error) {
                        console.error('è·å–æ±‡æ€»ä¿¡æ¯æ—¶å‡ºé”™:', error);
                        showAlert('åŠ è½½æ±‡æ€»ä¿¡æ¯å¤±è´¥', 'error');
                    }
                };
                
                const convertToDistance = (record) => {
                    const exerciseType = exerciseTypes.find(type => type.id === record.exercise_type);
                    if (!exerciseType) return 0;
                    
                    // åº”ç”¨ç›¸åŒçš„è½¬æ¢è§„åˆ™
                    if (exerciseType.unit === 'å°æ—¶') {
                        // ç‰¹æ®Šæƒ…å†µï¼šæ¸¸æ³³ 1 å°æ—¶ = 10 km
                        if (exerciseType.id === 'swimming') {
                            return record.value * 10;
                        } 
                        // é»˜è®¤æƒ…å†µï¼šå…¶ä»–å°æ—¶ç±»æ´»åŠ¨ 1 å°æ—¶ = 5 km
                        else {
                            return record.value * 5;
                        }
                    } 
                    // ç‰¹æ®Šæƒ…å†µï¼šéª‘è½¦ 10 km = 5 km ç›®æ ‡
                    else if (exerciseType.id === 'cycling') {
                        return record.value * 0.5;
                    } 
                    // é»˜è®¤æƒ…å†µï¼šå…¬é‡Œç±»æ´»åŠ¨
                    else {
                        return record.value;
                    }
                };
                
                const loadAIRecommendations = async (goal, totalRecords, totalDistance, exerciseTypeStats, progress) => {
                    summaryStats.aiLoading = true;
                    summaryStats.aiRecommendations = [];
                    
                    try {
                        const userData = {
                            totalRecords: totalRecords,
                            totalDistance: totalDistance,
                            exerciseTypeCount: Object.keys(exerciseTypeStats).length,
                            exerciseTypes: Object.keys(exerciseTypeStats),
                            goalProgress: progress.percentage,
                            goalTarget: progress.target
                        };
                        
                        const aiResponse = await fetch('/api/spark/recommendations', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + localStorage.getItem('token')
                            },
                            body: JSON.stringify(userData)
                        });
                        
                        const aiData = await aiResponse.json();
                        if (aiData.success) {
                            summaryStats.aiRecommendations = aiData.recommendations;
                        }
                    } catch (aiError) {
                        console.error('è·å–AIå»ºè®®å¤±è´¥:', aiError);
                    } finally {
                        summaryStats.aiLoading = false;
                    }
                };
                
                // è·å–ä½“é‡å˜åŒ–çš„é¢œè‰²ç±»
                const getWeightChangeClass = (stats) => {
                    if (!stats.initialWeight || !stats.currentWeight) return '';
                    
                    const change = stats.currentWeight - stats.initialWeight;
                    // å¦‚æœæ˜¯å‡é‡ç›®æ ‡
                    if (stats.initialWeight > stats.targetWeight) {
                        return change <= 0 ? 'weight-change-positive' : 'weight-change-negative';
                    } 
                    // å¦‚æœæ˜¯å¢é‡ç›®æ ‡
                    else if (stats.initialWeight < stats.targetWeight) {
                        return change >= 0 ? 'weight-change-positive' : 'weight-change-negative';
                    }
                    return '';
                };
                
                const deleteGoal = (goal) => {
                    showConfirm(
                        'ç¡®è®¤åˆ é™¤',
                        'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¿åŠ¨ç›®æ ‡å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚',
                        async () => {
                            try {
                                // ä½¿ç”¨ç›®æ ‡ç®¡ç†æ¨¡å—åˆ é™¤ç›®æ ‡
                                window.GoalManagementModule.setCurrentUser(currentUser.value);
                                await window.GoalManagementModule.deleteGoal(goal.id);
                                
                                showAlert('ç›®æ ‡åˆ é™¤æˆåŠŸï¼', 'success');
                                await fetchGoals();
                            } catch (error) {
                                console.error('åˆ é™¤ç›®æ ‡æ—¶å‡ºé”™:', error);
                                showAlert('åˆ é™¤ç›®æ ‡å¤±è´¥: ' + error.message, 'error');
                            }
                        }
                    );
                };
                
                const closeModal = () => {
                    // å…ˆä¿å­˜å½“å‰çš„modalç±»å‹ç”¨äºåˆ¤æ–­
                    const currentType = modal.type;
                    
                    // æ¸…ç©ºæ‰€æœ‰è¡¨å•æ•°æ®
                    if (currentType === 'checkin') {
                        checkInForm.goalId = '';
                        checkInForm.exerciseType = 'running';
                        checkInForm.value = 0;
                        checkInForm.weight = null;
                        checkInForm.date = new Date().toISOString().split('T')[0];
                        checkInForm.note = '';
                        checkInForm.image = null;
                        checkInForm.imagePreview = null;
                        checkInForm.uploadedImageUrl = null;
                        
                        // æ¸…é™¤æ–‡ä»¶è¾“å…¥å…ƒç´ 
                        const fileInput = document.getElementById('checkin-image');
                        if (fileInput) {
                            fileInput.value = '';
                        }
                    } else if (currentType === 'editRecord') {
                        editRecordForm.id = null;
                        editRecordForm.exerciseType = '';
                        editRecordForm.value = 0;
                        editRecordForm.weight = null;
                        editRecordForm.date = '';
                        editRecordForm.note = '';
                        editRecordForm.existingImageUrl = null;
                        editRecordForm.uploadedImageUrl = null;
                        editRecordForm.imagePreview = null;
                        editRecordForm.deletedImage = false;
                        
                        // æ¸…é™¤æ–‡ä»¶è¾“å…¥å…ƒç´ 
                        const editFileInput = document.getElementById('edit-record-image');
                        if (editFileInput) {
                            editFileInput.value = '';
                        }
                    } else {
                        // å…¶ä»–æ¨¡æ€æ¡†ç±»å‹
                        resetGoalForm();
                    }
                    
                    modal.visible = false;
                    modal.type = '';
                    modal.title = '';
                };
                
                const showConfirm = (title, message, onConfirm, onCancel) => {
                    if (!onCancel) {
                        onCancel = function() {};
                    }
                    
                    confirmDialog.visible = true;
                    confirmDialog.message = message;
                    confirmDialog.onConfirm = function() {
                        confirmDialog.visible = false;
                        onConfirm();
                    };
                    confirmDialog.onCancel = function() {
                        confirmDialog.visible = false;
                        onCancel();
                    };
                };
                
                const showAlert = (message, type) => {
                    if (!type) type = 'info';
                    alert.visible = true;
                    alert.message = message;
                    alert.type = type;
                    
                    setTimeout(() => {
                        alert.visible = false;
                    }, 3000);
                };
                
                const hideAlert = () => {
                    alert.visible = false;
                };
                
                const logout = () => {
                    localStorage.removeItem('token');
                    localStorage.removeItem('currentUser');
                    window.location.href = '/login.html';
                };
                
                // ç”Ÿå‘½å‘¨æœŸé’©å­
                onMounted(() => {
                    if (!checkAuth()) return;
                    
                    initDateFields();
                    fetchGoals();
                });
                
                // æš´éœ²ç»™æ¨¡æ¿
                return {
                    // çŠ¶æ€
                    isLoadingGoals,
                    isAddingGoal,
                    isSubmittingCheckIn,
                    isUpdatingGoal,
                    isUpdatingRecord,
                    
                    // æ•°æ®
                    goals,
                    detailRecords,
                    summaryStats,
                    currentUser,
                    goalProgressMap,
                    exerciseTypes,
                    groupedDetailRecords,
                    
                    // è¡¨å•
                    newGoal,
                    checkInForm,
                    editForm,
                    editRecordForm,
                    
                    // æ¨¡æ€æ¡†
                    modal,
                    confirmDialog,
                    alert,
                    
                    // æ–¹æ³•
                    updateDateFields,
                    getPeriodText,
                    formatDate,
                    getGoalStatus,
                    getGoalStatusLabel,
                    getGoalStatusBadge,
                    calculateWeightProgress,
                    calculateWeightProgressPercentage,
                    getWeightProgressColor,
                    getExerciseTypeName,
                    getExerciseUnit,
                    showAddGoalModal,
                    showCheckInModal,
                    submitCheckIn,
                    showDetailsModal,
                    calculateDailyTotal: (records) => {
                        return window.CheckInManagementModule.calculateDailyTotal(records);
                    },
                    showEditRecordModal,
                    updateRecord,
                    deleteRecord,
                    showGoalSummary,
                    showEditGoalModal,
                    addGoal,
                    updateGoal,
                    deleteGoal,
                    closeModal,
                    showConfirm,
                    showAlert,
                    hideAlert,
                    logout,
                    calculateTimeProgress,
                    getWeightChangeClass,
                    exportSummaryAsImage,
                    handleImageUpload,
                    handleEditRecordImageUpload,
                    deleteExistingImage
                };
            }
        }).mount('#app');
    </script>
</body>
</html>