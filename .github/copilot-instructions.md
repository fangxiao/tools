# Copilot / AI Agent Instructions

Purpose: Help AI coding agents become productive quickly in this repository by documenting architecture, conventions, workflows, and concrete examples.

- **Entry point:** `app.js` – an Express server that wires routes, middleware, rate-limiting, static assets and starts the HTTP server.
- **Database layer:** `database.js` exposes many CRUD helpers used across routes (user, items, categories, logs, exercise goals/records, visited cities).
- **Auth:** `middleware/auth.js` implements JWT generation (`generateToken`) and `authenticateToken`. Note: `JWT_SECRET` comes from env (fallback in dev).
- **AI integration:** `services/qwenService.js` calls an external model via `QWEN_API_KEY` and `QWEN_API_URL`. The server falls back to deterministic/default suggestions when the key is missing.

Key patterns and conventions
- All API endpoints are under `/api/` and commonly require a query parameter `userId` for scoping. Example: `GET /api/items?userId=1`.
- Static UI is served from `public/`. Tools are exposed under `/tools/*` (see `app.use('/tools/exercise', ...)`).
- Rate limiting: `express-rate-limit` is configured with global, api, read, write, and stricter write limits. Look in `app.js` for the exact routes that apply `writeLimiter` and `readLimiter`.
- Error handling: A global error middleware logs via `middleware/logger` and returns a 500 JSON payload. Prefer returning JSON errors consistent with existing handlers.
- Database callbacks: `database.js` uses Node-style callbacks; many route handlers expect callbacks (err, result). Follow the same pattern when adding DB helpers.

Developer workflows
- Start (production): `npm start` (runs `node app.js`).
- Dev (auto-restart): `npm run dev` (uses `nodemon app.js`).
- Health/status checks: `GET /health` and `GET /status` endpoints for quick smoke tests.
- Environment variables of interest:
  - `PORT` – server port
  - `NODE_ENV` – affects token expiry and http->https redirect
  - `JWT_SECRET` – required for production JWTs
  - `QWEN_API_KEY`, `QWEN_MODEL`, `QWEN_API_URL` – control AI integration

Integration notes and examples
- AI recommendations route: `GET /api/exercise-goals/:goalId/recommendations?userId=...` — checks `services/qwenService.isAvailable()` and falls back to `getDefaultRecommendations` in `app.js` when the API key is missing.
- JWT flow example: `POST /api/login` returns `{ id, username, token }` where `token` was generated by `middleware/auth.generateToken(user)`.
- Sample write-protected call pattern: include `userId` as query, and pass `Authorization: Bearer <token>` for endpoints that require `authenticateToken` (e.g., `PUT /api/users/password`).

Files to inspect when changing behavior
- `app.js` — routing, limits, static serving, AI orchestration and examples of business logic (goal progress calculation).
- `database.js` — all SQL and persistence helpers. Modify here to change data model or add queries.
- `services/qwenService.js` — AI client usage (axios + env-based configuration).
- `middleware/auth.js` and `middleware/logger.js` — auth and logging conventions.
- `public/` and `tools/` — UI assets and helper tools served statically.

Small implementation rules for AI agents
- Keep JSON error shapes consistent with existing routes (use `{ error: '...' }`).
- Preserve `userId` query param convention for scoping unless you refactor all callers.
- When adding AI calls, check `services/qwenService.isAvailable()` and provide a graceful fallback.
- Avoid changing rate-limit defaults without coordination; routes are intentionally split between read/write limits.

If anything looks missing or you want examples included (curl snippets, sample payloads), tell me which endpoints you want expanded and I will iterate.
